{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {
    "papermill": {
     "duration": 0.045609,
     "end_time": "2021-01-21T14:11:14.604380",
     "exception": false,
     "start_time": "2021-01-21T14:11:14.558771",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "# TABLE OF CONTENTS\n",
    "\n",
    "* [1. INTRODUCTION](#section-one)\n",
    "* [2. SETUP](#section-two)\n",
    "    - [2.1 Draw Packages](#subsection-two-one)\n",
    "    - [2.2 Import/Wrangle Data](#subsection-two-two)\n",
    "    - [2.3 Generate the portfolio formation dates for our sample (Key idea #1)](#subsection-two-three)\n",
    "* [3. TESTING OVERREACTION HYPOTHESIS](#section-three)\n",
    "    - [3.1 Question 1: How do we construct portfolios?](#subsection-three-one)\n",
    "        - [3.1.1 Constructing portfolios on a single date (1 instance)](#subsection-three-one-one)\n",
    "        - [3.1.2 Constructing portfolios on each date (N instance) with a function (Key idea #2)](#subsection-three-one-two)\n",
    "    - [3.2 Question 2: How do we calculate holding period returns?](#subsection-three-two)\n",
    "        - [3.2.1 Constructing holding period returns on a single portfolio/date (1 instance)](#subsection-three-two-one)\n",
    "        - [3.2.2 Constructing holding period returns on each portfolio/date (N instance) with a function (Key idea #3)](#subsection-three-two-two)\n",
    "    - [3.3 Question 3: Do current losers beat current winners in the future?](#subsection-three-three)\n",
    "* [4. CONCLUSION](#section-four)\n",
    "* [5. PROBLEM SET 1: QUESTION 2](#section-five)\n",
    "* [6. REFERENCES](#section-six)\n",
    "\n",
    "Reminder: The dataset is for the use of this class only. Please do not share it beyond the classroom."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "papermill": {
     "duration": 0.043318,
     "end_time": "2021-01-21T14:11:14.691566",
     "exception": false,
     "start_time": "2021-01-21T14:11:14.648248",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "<a id=\"section-one\"></a>\n",
    "# 1. INTRODUCTION\n",
    "\n",
    "## Team members\n",
    "### Lucas Sebastian A0112080B\n",
    "### Sekson Ounsaengchan (Beer) A0227885M\n",
    "### Zhao Mengyu (Jessica) A0227914B\n",
    "\n",
    "## De Bondt and Thaler (1985)\n",
    "\n",
    "In the seminal paper, \"Does the stock market overreact?\" De Bondt and Thaler (1985) discover significant evidence of weak-form market inefficiencies. \n",
    "\n",
    "## Objective\n",
    "\n",
    "- Test for the overreaction hypothesis in financial markets based on \n",
    "  [De Bondt and Thaler (1985), Does the Stock Market Overreact?,\n",
    "  Journal of Finance](http://onlinelibrary.wiley.com/doi/10.1111/j.1540-6261.1985.tb05004.x/full).\n",
    "- Get similar results to Figure 3 in the paper.\n",
    "\n",
    "## Motivation\n",
    "\n",
    "- \"Research in experimental psychology has suggested that, in violation of Bayes' rule, most people tend to \"overreact\" to unexpected and dramatic news events.\" ~ De Bondt and Thaler (1985)\n",
    "- Does such behavior matter at the market level?\n",
    "  \n",
    "Note: Replication is imperfect, but in the spirit of the original paper. Empirical choices in data selection (number of observations required for portfolios, exchange types, etc.) and in portfolio performance evaluation (computing abnormal returns, forming portfolios, etc.) are different from the original paper. \n",
    "\n",
    "\n",
    "## Key Steps\n",
    "\n",
    "The beauty in De Bondt and Thaler's empirical test of overreaction hypothesis is its simplicity. Specifically, what DeBondt and Thaler do is calculate portfolio returns for some formation period – i.e. previous 36-month performance – and then see how that particular portfolio performs in an evaluation period – i.e. subsequent 36-month performance. To test the overreaction hypothesis, De Bondt and Thaler form loser and winner portfolios composed of the 30 worst-performing and 30 best-performing stocks, respectively, over the formation period. They then follow these portfolios for the subsequent 36 months and evaluate and compare their performance. The key steps are summarized below:\n",
    "\n",
    "1. Identify portfolio formation dates.\n",
    "2. Identify winner and loser portfolios by ranking securities by past returns.\n",
    "3. Track and calculate the holding period returns for each portfolio."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "papermill": {
     "duration": 0.044098,
     "end_time": "2021-01-21T14:11:14.780423",
     "exception": false,
     "start_time": "2021-01-21T14:11:14.736325",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "<a id=\"section-two\"></a>\n",
    "# 2. SETUP"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "papermill": {
     "duration": 0.043354,
     "end_time": "2021-01-21T14:11:14.867707",
     "exception": false,
     "start_time": "2021-01-21T14:11:14.824353",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "<a id=\"subsection-two-one\"></a>\n",
    "## 2.1 Draw Packages"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "metadata": {
    "papermill": {
     "duration": 0.761192,
     "end_time": "2021-01-21T14:11:15.673903",
     "exception": false,
     "start_time": "2021-01-21T14:11:14.912711",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "import pandas as pd\n",
    "import numpy as np\n",
    "import matplotlib.pyplot as plt\n",
    "from datetime import datetime, timedelta\n",
    "from scipy import stats\n",
    "\n",
    "%matplotlib inline"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "papermill": {
     "duration": 0.043817,
     "end_time": "2021-01-21T14:11:15.762412",
     "exception": false,
     "start_time": "2021-01-21T14:11:15.718595",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "<a id=\"subsection-two-two\"></a>\n",
    "## 2.2 Import/Wrangle Data"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "papermill": {
     "duration": 0.044837,
     "end_time": "2021-01-21T14:11:15.851250",
     "exception": false,
     "start_time": "2021-01-21T14:11:15.806413",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "This is a monthly stock-level return file. The data have been pre-screened to include only common stock (SHRCD 10 or 11) and listings on AMEX, NYSE or NASDAQ (EXCHCD 1, 2 or 3). "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "metadata": {
    "papermill": {
     "duration": 3.585117,
     "end_time": "2021-01-21T14:11:19.480684",
     "exception": false,
     "start_time": "2021-01-21T14:11:15.895567",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "C:\\Users\\sekso\\anaconda3\\lib\\site-packages\\IPython\\core\\interactiveshell.py:3444: DtypeWarning: Columns (2) have mixed types.Specify dtype option on import or set low_memory=False.\n",
      "  exec(code_obj, self.user_global_ns, self.user_ns)\n"
     ]
    }
   ],
   "source": [
    "local_path = \"C:/Users/sekso/Desktop/MBA/sem4/Fintech/Bootcamp Codes and Data/03 Behavioral Finance/\"\n",
    "# df_crsp = pd.read_csv(local_path + 'monthly.csv')  # Load part of the file to have a look\n",
    "\n",
    "df_crsp = pd.read_csv(local_path + \"msf_200901-202012.csv\")  # Load csv file into dataframe"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "papermill": {
     "duration": 0.051075,
     "end_time": "2021-01-21T14:11:19.587950",
     "exception": false,
     "start_time": "2021-01-21T14:11:19.536875",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "Permno is a unique stock/share class-level identifier."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "metadata": {
    "papermill": {
     "duration": 0.066441,
     "end_time": "2021-01-21T14:11:19.700710",
     "exception": false,
     "start_time": "2021-01-21T14:11:19.634269",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "<class 'pandas.core.frame.DataFrame'>\n",
      "RangeIndex: 1033173 entries, 0 to 1033172\n",
      "Data columns (total 9 columns):\n",
      " #   Column  Non-Null Count    Dtype  \n",
      "---  ------  --------------    -----  \n",
      " 0   PERMNO  1033173 non-null  int64  \n",
      " 1   date    1033173 non-null  int64  \n",
      " 2   SICCD   1026989 non-null  object \n",
      " 3   PRC     1013647 non-null  float64\n",
      " 4   RET     1021281 non-null  object \n",
      " 5   SHROUT  1026302 non-null  float64\n",
      " 6   SPREAD  27865 non-null    float64\n",
      " 7   vwretd  1033173 non-null  float64\n",
      " 8   ewretd  1033173 non-null  float64\n",
      "dtypes: float64(5), int64(2), object(2)\n",
      "memory usage: 70.9+ MB\n"
     ]
    }
   ],
   "source": [
    "df_crsp.info()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "papermill": {
     "duration": 0.045308,
     "end_time": "2021-01-21T14:11:19.792385",
     "exception": false,
     "start_time": "2021-01-21T14:11:19.747077",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    " Panda treats DATE as an int64 object. We need DATE to be a datetime object, so we will parse the dates."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "metadata": {
    "papermill": {
     "duration": 0.067212,
     "end_time": "2021-01-21T14:11:19.904814",
     "exception": false,
     "start_time": "2021-01-21T14:11:19.837602",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>PERMNO</th>\n",
       "      <th>date</th>\n",
       "      <th>SICCD</th>\n",
       "      <th>PRC</th>\n",
       "      <th>RET</th>\n",
       "      <th>SHROUT</th>\n",
       "      <th>SPREAD</th>\n",
       "      <th>vwretd</th>\n",
       "      <th>ewretd</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>10001</td>\n",
       "      <td>20090130</td>\n",
       "      <td>4920.0</td>\n",
       "      <td>8.502</td>\n",
       "      <td>0.03414</td>\n",
       "      <td>4297.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>-0.077475</td>\n",
       "      <td>-0.024042</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>10001</td>\n",
       "      <td>20090227</td>\n",
       "      <td>4920.0</td>\n",
       "      <td>8.940</td>\n",
       "      <td>0.056222</td>\n",
       "      <td>4297.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>-0.100175</td>\n",
       "      <td>-0.107606</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>10001</td>\n",
       "      <td>20090331</td>\n",
       "      <td>4920.0</td>\n",
       "      <td>8.180</td>\n",
       "      <td>-0.080537</td>\n",
       "      <td>4300.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.086813</td>\n",
       "      <td>0.107474</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>10001</td>\n",
       "      <td>20090430</td>\n",
       "      <td>4920.0</td>\n",
       "      <td>8.500</td>\n",
       "      <td>0.044621</td>\n",
       "      <td>4300.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.109483</td>\n",
       "      <td>0.192762</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>10001</td>\n",
       "      <td>20090529</td>\n",
       "      <td>4920.0</td>\n",
       "      <td>8.480</td>\n",
       "      <td>0.002941</td>\n",
       "      <td>4354.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.067797</td>\n",
       "      <td>0.102330</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "   PERMNO      date   SICCD    PRC        RET  SHROUT  SPREAD    vwretd  \\\n",
       "0   10001  20090130  4920.0  8.502    0.03414  4297.0     NaN -0.077475   \n",
       "1   10001  20090227  4920.0  8.940   0.056222  4297.0     NaN -0.100175   \n",
       "2   10001  20090331  4920.0  8.180  -0.080537  4300.0     NaN  0.086813   \n",
       "3   10001  20090430  4920.0  8.500   0.044621  4300.0     NaN  0.109483   \n",
       "4   10001  20090529  4920.0  8.480   0.002941  4354.0     NaN  0.067797   \n",
       "\n",
       "     ewretd  \n",
       "0 -0.024042  \n",
       "1 -0.107606  \n",
       "2  0.107474  \n",
       "3  0.192762  \n",
       "4  0.102330  "
      ]
     },
     "execution_count": 4,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "df_crsp.head()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "papermill": {
     "duration": 0.045361,
     "end_time": "2021-01-21T14:11:19.998095",
     "exception": false,
     "start_time": "2021-01-21T14:11:19.952734",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "Letters, such as `C`, identify special cases in this dataset. In this case, we ask pandas to treat `C` as a null value. Please delve into the dataset documentation carefully, so to make sure that what you do is reasonable. "
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "papermill": {
     "duration": 0.046053,
     "end_time": "2021-01-21T14:11:20.089742",
     "exception": false,
     "start_time": "2021-01-21T14:11:20.043689",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "We are re-importing the dataset with date parsing (into datetime object) and ret correction (from \"C\" to a null value)."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "metadata": {
    "papermill": {
     "duration": 2.253045,
     "end_time": "2021-01-21T14:11:22.388037",
     "exception": false,
     "start_time": "2021-01-21T14:11:20.134992",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Index(['PERMNO', 'date', 'SICCD', 'PRC', 'RET', 'SHROUT', 'SPREAD', 'vwretd',\n",
      "       'ewretd'],\n",
      "      dtype='object')\n",
      "<class 'pandas.core.indexes.base.Index'>\n"
     ]
    }
   ],
   "source": [
    "df_crsp = pd.read_csv(local_path + \"msf_200901-202012.csv\", na_values=[\"B\", \"C\", \"Z\"], parse_dates=[\"date\"])\n",
    "\n",
    "# The output from WRDS returns a mixed of small and large cap column names. Let's standardize everything in small caps.\n",
    "cols = df_crsp.columns\n",
    "print(cols)\n",
    "print(type(cols))\n",
    "\n",
    "# List comprehension [expression for variable in iterable]\n",
    "df_crsp.columns = [c.lower() for c in cols]"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "papermill": {
     "duration": 0.045328,
     "end_time": "2021-01-21T14:11:22.480623",
     "exception": false,
     "start_time": "2021-01-21T14:11:22.435295",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "[HERE](http://www.learnbyexample.org/python-list-comprehension/) for more details on list comprehension"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "metadata": {
    "papermill": {
     "duration": 0.062646,
     "end_time": "2021-01-21T14:11:22.596895",
     "exception": false,
     "start_time": "2021-01-21T14:11:22.534249",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "<class 'pandas.core.frame.DataFrame'>\n",
      "RangeIndex: 1033173 entries, 0 to 1033172\n",
      "Data columns (total 9 columns):\n",
      " #   Column  Non-Null Count    Dtype         \n",
      "---  ------  --------------    -----         \n",
      " 0   permno  1033173 non-null  int64         \n",
      " 1   date    1033173 non-null  datetime64[ns]\n",
      " 2   siccd   1026803 non-null  float64       \n",
      " 3   prc     1013647 non-null  float64       \n",
      " 4   ret     1006985 non-null  float64       \n",
      " 5   shrout  1026302 non-null  float64       \n",
      " 6   spread  27865 non-null    float64       \n",
      " 7   vwretd  1033173 non-null  float64       \n",
      " 8   ewretd  1033173 non-null  float64       \n",
      "dtypes: datetime64[ns](1), float64(7), int64(1)\n",
      "memory usage: 70.9 MB\n"
     ]
    }
   ],
   "source": [
    "df_crsp.info()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "papermill": {
     "duration": 0.046857,
     "end_time": "2021-01-21T14:11:22.692153",
     "exception": false,
     "start_time": "2021-01-21T14:11:22.645296",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "Now date variable name is in lowercase and of type datetime64."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "metadata": {
    "papermill": {
     "duration": 0.063813,
     "end_time": "2021-01-21T14:11:22.802799",
     "exception": false,
     "start_time": "2021-01-21T14:11:22.738986",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>permno</th>\n",
       "      <th>date</th>\n",
       "      <th>siccd</th>\n",
       "      <th>prc</th>\n",
       "      <th>ret</th>\n",
       "      <th>shrout</th>\n",
       "      <th>spread</th>\n",
       "      <th>vwretd</th>\n",
       "      <th>ewretd</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>10001</td>\n",
       "      <td>2009-01-30</td>\n",
       "      <td>4920.0</td>\n",
       "      <td>8.502</td>\n",
       "      <td>0.034140</td>\n",
       "      <td>4297.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>-0.077475</td>\n",
       "      <td>-0.024042</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>10001</td>\n",
       "      <td>2009-02-27</td>\n",
       "      <td>4920.0</td>\n",
       "      <td>8.940</td>\n",
       "      <td>0.056222</td>\n",
       "      <td>4297.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>-0.100175</td>\n",
       "      <td>-0.107606</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>10001</td>\n",
       "      <td>2009-03-31</td>\n",
       "      <td>4920.0</td>\n",
       "      <td>8.180</td>\n",
       "      <td>-0.080537</td>\n",
       "      <td>4300.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.086813</td>\n",
       "      <td>0.107474</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>10001</td>\n",
       "      <td>2009-04-30</td>\n",
       "      <td>4920.0</td>\n",
       "      <td>8.500</td>\n",
       "      <td>0.044621</td>\n",
       "      <td>4300.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.109483</td>\n",
       "      <td>0.192762</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>10001</td>\n",
       "      <td>2009-05-29</td>\n",
       "      <td>4920.0</td>\n",
       "      <td>8.480</td>\n",
       "      <td>0.002941</td>\n",
       "      <td>4354.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.067797</td>\n",
       "      <td>0.102330</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "   permno       date   siccd    prc       ret  shrout  spread    vwretd  \\\n",
       "0   10001 2009-01-30  4920.0  8.502  0.034140  4297.0     NaN -0.077475   \n",
       "1   10001 2009-02-27  4920.0  8.940  0.056222  4297.0     NaN -0.100175   \n",
       "2   10001 2009-03-31  4920.0  8.180 -0.080537  4300.0     NaN  0.086813   \n",
       "3   10001 2009-04-30  4920.0  8.500  0.044621  4300.0     NaN  0.109483   \n",
       "4   10001 2009-05-29  4920.0  8.480  0.002941  4354.0     NaN  0.067797   \n",
       "\n",
       "     ewretd  \n",
       "0 -0.024042  \n",
       "1 -0.107606  \n",
       "2  0.107474  \n",
       "3  0.192762  \n",
       "4  0.102330  "
      ]
     },
     "execution_count": 7,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "df_crsp.head()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "papermill": {
     "duration": 0.046105,
     "end_time": "2021-01-21T14:11:22.895797",
     "exception": false,
     "start_time": "2021-01-21T14:11:22.849692",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "Notice that \"c\" is now NaN (i.e., Not a Number) - this is Python's way of representing missing value."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "papermill": {
     "duration": 0.047729,
     "end_time": "2021-01-21T14:11:22.990911",
     "exception": false,
     "start_time": "2021-01-21T14:11:22.943182",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "Exploring the distributional characteristics of our variables."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "metadata": {
    "papermill": {
     "duration": 0.565702,
     "end_time": "2021-01-21T14:11:23.609261",
     "exception": false,
     "start_time": "2021-01-21T14:11:23.043559",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>permno</th>\n",
       "      <th>siccd</th>\n",
       "      <th>prc</th>\n",
       "      <th>ret</th>\n",
       "      <th>shrout</th>\n",
       "      <th>spread</th>\n",
       "      <th>vwretd</th>\n",
       "      <th>ewretd</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>count</th>\n",
       "      <td>1.033173e+06</td>\n",
       "      <td>1.026803e+06</td>\n",
       "      <td>1.013647e+06</td>\n",
       "      <td>1.006985e+06</td>\n",
       "      <td>1.026302e+06</td>\n",
       "      <td>27865.000000</td>\n",
       "      <td>1.033173e+06</td>\n",
       "      <td>1.033173e+06</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>mean</th>\n",
       "      <td>6.038065e+04</td>\n",
       "      <td>5.818966e+03</td>\n",
       "      <td>5.950448e+01</td>\n",
       "      <td>1.215098e-02</td>\n",
       "      <td>9.756848e+04</td>\n",
       "      <td>0.578258</td>\n",
       "      <td>1.214390e-02</td>\n",
       "      <td>1.226344e-02</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>std</th>\n",
       "      <td>3.370057e+04</td>\n",
       "      <td>2.217899e+03</td>\n",
       "      <td>2.594325e+03</td>\n",
       "      <td>1.573849e-01</td>\n",
       "      <td>3.703394e+05</td>\n",
       "      <td>3.714150</td>\n",
       "      <td>4.422972e-02</td>\n",
       "      <td>5.223411e-02</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>min</th>\n",
       "      <td>1.000100e+04</td>\n",
       "      <td>0.000000e+00</td>\n",
       "      <td>-5.886000e+02</td>\n",
       "      <td>-9.936000e-01</td>\n",
       "      <td>2.000000e+00</td>\n",
       "      <td>0.000700</td>\n",
       "      <td>-1.417330e-01</td>\n",
       "      <td>-2.075010e-01</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>25%</th>\n",
       "      <td>1.670400e+04</td>\n",
       "      <td>3.840000e+03</td>\n",
       "      <td>7.620000e+00</td>\n",
       "      <td>-4.276600e-02</td>\n",
       "      <td>8.350000e+03</td>\n",
       "      <td>0.080000</td>\n",
       "      <td>-1.041000e-02</td>\n",
       "      <td>-1.138800e-02</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>50%</th>\n",
       "      <td>7.947200e+04</td>\n",
       "      <td>6.726000e+03</td>\n",
       "      <td>1.853000e+01</td>\n",
       "      <td>6.452000e-03</td>\n",
       "      <td>2.702300e+04</td>\n",
       "      <td>0.170000</td>\n",
       "      <td>1.426900e-02</td>\n",
       "      <td>1.073600e-02</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>75%</th>\n",
       "      <td>9.001200e+04</td>\n",
       "      <td>6.726000e+03</td>\n",
       "      <td>3.784000e+01</td>\n",
       "      <td>5.504200e-02</td>\n",
       "      <td>7.114600e+04</td>\n",
       "      <td>0.440000</td>\n",
       "      <td>3.751400e-02</td>\n",
       "      <td>3.888400e-02</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>max</th>\n",
       "      <td>9.343600e+04</td>\n",
       "      <td>9.999000e+03</td>\n",
       "      <td>3.478150e+05</td>\n",
       "      <td>1.988359e+01</td>\n",
       "      <td>2.920640e+07</td>\n",
       "      <td>475.000000</td>\n",
       "      <td>1.296770e-01</td>\n",
       "      <td>1.927620e-01</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "             permno         siccd           prc           ret        shrout  \\\n",
       "count  1.033173e+06  1.026803e+06  1.013647e+06  1.006985e+06  1.026302e+06   \n",
       "mean   6.038065e+04  5.818966e+03  5.950448e+01  1.215098e-02  9.756848e+04   \n",
       "std    3.370057e+04  2.217899e+03  2.594325e+03  1.573849e-01  3.703394e+05   \n",
       "min    1.000100e+04  0.000000e+00 -5.886000e+02 -9.936000e-01  2.000000e+00   \n",
       "25%    1.670400e+04  3.840000e+03  7.620000e+00 -4.276600e-02  8.350000e+03   \n",
       "50%    7.947200e+04  6.726000e+03  1.853000e+01  6.452000e-03  2.702300e+04   \n",
       "75%    9.001200e+04  6.726000e+03  3.784000e+01  5.504200e-02  7.114600e+04   \n",
       "max    9.343600e+04  9.999000e+03  3.478150e+05  1.988359e+01  2.920640e+07   \n",
       "\n",
       "             spread        vwretd        ewretd  \n",
       "count  27865.000000  1.033173e+06  1.033173e+06  \n",
       "mean       0.578258  1.214390e-02  1.226344e-02  \n",
       "std        3.714150  4.422972e-02  5.223411e-02  \n",
       "min        0.000700 -1.417330e-01 -2.075010e-01  \n",
       "25%        0.080000 -1.041000e-02 -1.138800e-02  \n",
       "50%        0.170000  1.426900e-02  1.073600e-02  \n",
       "75%        0.440000  3.751400e-02  3.888400e-02  \n",
       "max      475.000000  1.296770e-01  1.927620e-01  "
      ]
     },
     "execution_count": 8,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "df_crsp.describe()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "papermill": {
     "duration": 0.046288,
     "end_time": "2021-01-21T14:11:23.702271",
     "exception": false,
     "start_time": "2021-01-21T14:11:23.655983",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "Notice that Prc (or Price) has 'negative' values. What is going on? The documentation says a dash prefixes the price when no closing price is available for that period and when the bid/ask average is used. We will take the absolute value of the price, which is sensible in most cases."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "metadata": {
    "papermill": {
     "duration": 0.168979,
     "end_time": "2021-01-21T14:11:23.919044",
     "exception": false,
     "start_time": "2021-01-21T14:11:23.750065",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "# Sanitize dataset\n",
    "\n",
    "# Drop observations with missing returns\n",
    "df_crsp = df_crsp[df_crsp.ret.notnull()]\n",
    "\n",
    "# Take the absolute value of the price\n",
    "df_crsp[\"prc\"] = np.abs(df_crsp[\"prc\"])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 10,
   "metadata": {
    "papermill": {
     "duration": 0.475591,
     "end_time": "2021-01-21T14:11:24.442285",
     "exception": false,
     "start_time": "2021-01-21T14:11:23.966694",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "# Set the index (to select easily on date)\n",
    "df_crsp = df_crsp.set_index(\"date\")\n",
    "df_crsp = df_crsp.sort_index()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "papermill": {
     "duration": 0.04789,
     "end_time": "2021-01-21T14:11:24.537899",
     "exception": false,
     "start_time": "2021-01-21T14:11:24.490009",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "[HERE](https://www.geeksforgeeks.org/python-pandas-dataframe-set_index/) for more details on on Pandas indexing."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "metadata": {
    "papermill": {
     "duration": 0.276266,
     "end_time": "2021-01-21T14:11:24.861365",
     "exception": false,
     "start_time": "2021-01-21T14:11:24.585099",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "# Compute continuously compounded returns (i.e. log returns).\n",
    "df_crsp[\"lret\"] = np.log(1 + df_crsp[\"ret\"])\n",
    "df_crsp[\"lvwretd\"] = np.log(1 + df_crsp[\"vwretd\"])\n",
    "df_crsp[\"lewretd\"] = np.log(1 + df_crsp[\"ewretd\"])\n",
    "\n",
    "# Compute the market cap\n",
    "df_crsp[\"size\"] = df_crsp[\"shrout\"] * df_crsp[\"prc\"]"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "papermill": {
     "duration": 0.049381,
     "end_time": "2021-01-21T14:11:24.958383",
     "exception": false,
     "start_time": "2021-01-21T14:11:24.909002",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "** Why are continously compounded returns (i.e., log returns) useful?"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 12,
   "metadata": {
    "papermill": {
     "duration": 0.064784,
     "end_time": "2021-01-21T14:11:25.070492",
     "exception": false,
     "start_time": "2021-01-21T14:11:25.005708",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>permno</th>\n",
       "      <th>siccd</th>\n",
       "      <th>prc</th>\n",
       "      <th>ret</th>\n",
       "      <th>shrout</th>\n",
       "      <th>spread</th>\n",
       "      <th>vwretd</th>\n",
       "      <th>ewretd</th>\n",
       "      <th>lret</th>\n",
       "      <th>lvwretd</th>\n",
       "      <th>lewretd</th>\n",
       "      <th>size</th>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>date</th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>2009-01-30</th>\n",
       "      <td>10001</td>\n",
       "      <td>4920.0</td>\n",
       "      <td>8.502</td>\n",
       "      <td>0.034140</td>\n",
       "      <td>4297.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>-0.077475</td>\n",
       "      <td>-0.024042</td>\n",
       "      <td>0.033570</td>\n",
       "      <td>-0.080641</td>\n",
       "      <td>-0.024336</td>\n",
       "      <td>36533.094</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2009-01-30</th>\n",
       "      <td>67467</td>\n",
       "      <td>5331.0</td>\n",
       "      <td>13.450</td>\n",
       "      <td>-0.071774</td>\n",
       "      <td>82117.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>-0.077475</td>\n",
       "      <td>-0.024042</td>\n",
       "      <td>-0.074480</td>\n",
       "      <td>-0.080641</td>\n",
       "      <td>-0.024336</td>\n",
       "      <td>1104473.650</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2009-01-30</th>\n",
       "      <td>90565</td>\n",
       "      <td>4899.0</td>\n",
       "      <td>13.560</td>\n",
       "      <td>0.135678</td>\n",
       "      <td>68432.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>-0.077475</td>\n",
       "      <td>-0.024042</td>\n",
       "      <td>0.127230</td>\n",
       "      <td>-0.080641</td>\n",
       "      <td>-0.024336</td>\n",
       "      <td>927937.920</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2009-01-30</th>\n",
       "      <td>92590</td>\n",
       "      <td>4841.0</td>\n",
       "      <td>18.350</td>\n",
       "      <td>0.049771</td>\n",
       "      <td>493269.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>-0.077475</td>\n",
       "      <td>-0.024042</td>\n",
       "      <td>0.048572</td>\n",
       "      <td>-0.080641</td>\n",
       "      <td>-0.024336</td>\n",
       "      <td>9051486.150</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2009-01-30</th>\n",
       "      <td>84073</td>\n",
       "      <td>6331.0</td>\n",
       "      <td>28.040</td>\n",
       "      <td>-0.095977</td>\n",
       "      <td>37254.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>-0.077475</td>\n",
       "      <td>-0.024042</td>\n",
       "      <td>-0.100900</td>\n",
       "      <td>-0.080641</td>\n",
       "      <td>-0.024336</td>\n",
       "      <td>1044602.160</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "            permno   siccd     prc       ret    shrout  spread    vwretd  \\\n",
       "date                                                                       \n",
       "2009-01-30   10001  4920.0   8.502  0.034140    4297.0     NaN -0.077475   \n",
       "2009-01-30   67467  5331.0  13.450 -0.071774   82117.0     NaN -0.077475   \n",
       "2009-01-30   90565  4899.0  13.560  0.135678   68432.0     NaN -0.077475   \n",
       "2009-01-30   92590  4841.0  18.350  0.049771  493269.0     NaN -0.077475   \n",
       "2009-01-30   84073  6331.0  28.040 -0.095977   37254.0     NaN -0.077475   \n",
       "\n",
       "              ewretd      lret   lvwretd   lewretd         size  \n",
       "date                                                             \n",
       "2009-01-30 -0.024042  0.033570 -0.080641 -0.024336    36533.094  \n",
       "2009-01-30 -0.024042 -0.074480 -0.080641 -0.024336  1104473.650  \n",
       "2009-01-30 -0.024042  0.127230 -0.080641 -0.024336   927937.920  \n",
       "2009-01-30 -0.024042  0.048572 -0.080641 -0.024336  9051486.150  \n",
       "2009-01-30 -0.024042 -0.100900 -0.080641 -0.024336  1044602.160  "
      ]
     },
     "execution_count": 12,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "df_crsp.head()\n",
    "# df_crsp.tail()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 13,
   "metadata": {
    "papermill": {
     "duration": 0.288867,
     "end_time": "2021-01-21T14:11:25.407193",
     "exception": false,
     "start_time": "2021-01-21T14:11:25.118326",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "image/png": "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\n",
      "text/plain": [
       "<Figure size 432x288 with 1 Axes>"
      ]
     },
     "metadata": {
      "needs_background": "light"
     },
     "output_type": "display_data"
    }
   ],
   "source": [
    "# Total market size over time\n",
    "\n",
    "ax = df_crsp.groupby([\"date\"])[\"size\"].sum().plot()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 14,
   "metadata": {
    "papermill": {
     "duration": 0.555344,
     "end_time": "2021-01-21T14:11:26.011730",
     "exception": false,
     "start_time": "2021-01-21T14:11:25.456386",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/plain": [
       "<matplotlib.lines.Line2D at 0x144b4acb910>"
      ]
     },
     "execution_count": 14,
     "metadata": {},
     "output_type": "execute_result"
    },
    {
     "data": {
      "image/png": "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\n",
      "text/plain": [
       "<Figure size 432x288 with 1 Axes>"
      ]
     },
     "metadata": {
      "needs_background": "light"
     },
     "output_type": "display_data"
    }
   ],
   "source": [
    "# Taking the log of market size\n",
    "ax = df_crsp.groupby([\"date\"])[\"size\"].sum().plot(logy=True)\n",
    "\n",
    "# Add some informative lines\n",
    "ax.axvline(x=datetime(1929, 10, 24), color=\"k\", linestyle=\":\")  # Black Monday\n",
    "ax.axvline(x=datetime(1987, 10, 19), color=\"k\", linestyle=\":\")  # Black Monday again"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "papermill": {
     "duration": 0.049391,
     "end_time": "2021-01-21T14:11:26.111493",
     "exception": false,
     "start_time": "2021-01-21T14:11:26.062102",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "Let's configure the parameters of our model."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "papermill": {
     "duration": 0.050733,
     "end_time": "2021-01-21T14:11:26.212571",
     "exception": false,
     "start_time": "2021-01-21T14:11:26.161838",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "<a id=\"subsection-two-three\"></a>\n",
    "## 2.3 Generate the portfolio formation dates for our sample (Key idea #1)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 15,
   "metadata": {
    "papermill": {
     "duration": 0.057071,
     "end_time": "2021-01-21T14:11:26.319758",
     "exception": false,
     "start_time": "2021-01-21T14:11:26.262687",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "# Parameters\n",
    "form_period = 36  # 36 Formation period, in month\n",
    "start_date = \"2012-01-01\"\n",
    "end_date = \"2020-12-31\""
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 16,
   "metadata": {
    "papermill": {
     "duration": 0.062966,
     "end_time": "2021-01-21T14:11:26.432259",
     "exception": false,
     "start_time": "2021-01-21T14:11:26.369293",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "C:\\Users\\sekso\\AppData\\Local\\Temp/ipykernel_21252/724698719.py:7: DeprecationWarning: `np.int` is a deprecated alias for the builtin `int`. To silence this warning, use `int` by itself. Doing this will not modify any behavior and is safe. When replacing `np.int`, you may wish to use e.g. `np.int64` or `np.int32` to specify the precision. If you wish to review your current use, check the release note link for additional information.\n",
      "Deprecated in NumPy 1.20; for more details and guidance: https://numpy.org/devdocs/release/1.20.0-notes.html#deprecations\n",
      "  start=start_date, end=end_date, freq=str(np.int(form_period)) + \"M\"\n"
     ]
    },
    {
     "data": {
      "text/plain": [
       "DatetimeIndex(['2012-01-31', '2015-01-31', '2018-01-31'], dtype='datetime64[ns]', freq='36M')"
      ]
     },
     "execution_count": 16,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "# Get the dates of portfolio formation.\n",
    "# The frequency tells how far apart to put the dates.\n",
    "# 'M' stand for month, 'MS' is for month start, to make sure we\n",
    "# have first day of the month. It needs to be a string, so we convert\n",
    "# our numbers to string.\n",
    "dates = pd.date_range(\n",
    "    start=start_date, end=end_date, freq=str(np.int(form_period)) + \"M\"\n",
    ")\n",
    "dates"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "papermill": {
     "duration": 0.049986,
     "end_time": "2021-01-21T14:11:26.532331",
     "exception": false,
     "start_time": "2021-01-21T14:11:26.482345",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "[HERE](https://pandas.pydata.org/pandas-docs/stable/user_guide/timeseries.html#offset-aliases) for more details on the various options to tell how far apart to put the dates.  \n",
    "[HERE](https://www.geeksforgeeks.org/python-pandas-date_range-method/) for more details on the date_range method in Pandas.\n",
    "\n",
    "** Why do we need the dates of portfolio formation for?  \n",
    "This datetime object is an essential input for the two core functions: the function that contructs loser/winner portfolios and the function that calculates holding period returns."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "papermill": {
     "duration": 0.049711,
     "end_time": "2021-01-21T14:11:26.632092",
     "exception": false,
     "start_time": "2021-01-21T14:11:26.582381",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "<a id=\"section-three\"></a>\n",
    "# 3. TESTING OVERREACTION HYPOTHESIS"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "papermill": {
     "duration": 0.049693,
     "end_time": "2021-01-21T14:11:26.731968",
     "exception": false,
     "start_time": "2021-01-21T14:11:26.682275",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "<a id=\"subsection-three-one\"></a>\n",
    "## 3.1 Question 1: How do we construct portfolios?"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "papermill": {
     "duration": 0.04963,
     "end_time": "2021-01-21T14:11:26.831396",
     "exception": false,
     "start_time": "2021-01-21T14:11:26.781766",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "For each portfolio formation date (listed in previous step), we are going to form portfolios based on past performance. Specifically, a stock's past performance is its cumulative return during the formation period before the formation date. Then, we will track the performance of the top and bottom performing portfolios, which we identify during the formation period, over the holding period."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "papermill": {
     "duration": 0.049863,
     "end_time": "2021-01-21T14:11:26.931000",
     "exception": false,
     "start_time": "2021-01-21T14:11:26.881137",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "<a id=\"subsection-three-one-one\"></a>\n",
    "## 3.1.1 Constructing portfolios on a single-date (1 instance)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "papermill": {
     "duration": 0.050093,
     "end_time": "2021-01-21T14:11:27.031492",
     "exception": false,
     "start_time": "2021-01-21T14:11:26.981399",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "Let's specify the model parameters for portfolio on a single-date (before we generalize later)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 17,
   "metadata": {
    "papermill": {
     "duration": 0.057068,
     "end_time": "2021-01-21T14:11:27.138767",
     "exception": false,
     "start_time": "2021-01-21T14:11:27.081699",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "form_period = 36  # 36 Formation period, in month\n",
    "n_stocks = 35  # Number of stocks in the top and bottom performance\n",
    "benchmark = \"ewretd\"  # Benchmark market return to use ('vwretd' or 'ewretd')"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 18,
   "metadata": {
    "papermill": {
     "duration": 0.078126,
     "end_time": "2021-01-21T14:11:27.268238",
     "exception": false,
     "start_time": "2021-01-21T14:11:27.190112",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "2012-01-31 00:00:00\n",
      "2009-01-31 00:00:00 2011-12-31 00:00:00\n"
     ]
    }
   ],
   "source": [
    "# Let's first do it for only one date.\n",
    "date = dates[0]\n",
    "print(dates[0])\n",
    "\n",
    "beg_dt = date - pd.offsets.MonthEnd(1) * form_period\n",
    "print(beg_dt, date - pd.offsets.MonthEnd(1))\n",
    "# Select obs for the formation period\n",
    "# crsp_t = df_crsp[beg_dt:date].copy()\n",
    "crsp_t = df_crsp[beg_dt : (date - pd.offsets.MonthEnd(1))].copy()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "papermill": {
     "duration": 0.051176,
     "end_time": "2021-01-21T14:11:27.371074",
     "exception": false,
     "start_time": "2021-01-21T14:11:27.319898",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "[HERE](https://www.w3resource.com/pandas/series/series-dt-to_pydatetime.php) for more details on the to_pydatetime() method in Pandas."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 19,
   "metadata": {
    "papermill": {
     "duration": 0.078355,
     "end_time": "2021-01-21T14:11:27.500420",
     "exception": false,
     "start_time": "2021-01-21T14:11:27.422065",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>permno</th>\n",
       "      <th>siccd</th>\n",
       "      <th>prc</th>\n",
       "      <th>ret</th>\n",
       "      <th>shrout</th>\n",
       "      <th>spread</th>\n",
       "      <th>vwretd</th>\n",
       "      <th>ewretd</th>\n",
       "      <th>lret</th>\n",
       "      <th>lvwretd</th>\n",
       "      <th>lewretd</th>\n",
       "      <th>size</th>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>date</th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>2009-02-27</th>\n",
       "      <td>80485</td>\n",
       "      <td>2830.0</td>\n",
       "      <td>4.03</td>\n",
       "      <td>-0.179226</td>\n",
       "      <td>69667.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>-0.100175</td>\n",
       "      <td>-0.107606</td>\n",
       "      <td>-0.197507</td>\n",
       "      <td>-0.105555</td>\n",
       "      <td>-0.113848</td>\n",
       "      <td>280758.01</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2009-02-27</th>\n",
       "      <td>89403</td>\n",
       "      <td>4941.0</td>\n",
       "      <td>19.92</td>\n",
       "      <td>-0.081181</td>\n",
       "      <td>29385.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>-0.100175</td>\n",
       "      <td>-0.107606</td>\n",
       "      <td>-0.084666</td>\n",
       "      <td>-0.105555</td>\n",
       "      <td>-0.113848</td>\n",
       "      <td>585349.20</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2009-02-27</th>\n",
       "      <td>92740</td>\n",
       "      <td>6726.0</td>\n",
       "      <td>15.20</td>\n",
       "      <td>-0.044326</td>\n",
       "      <td>200.0</td>\n",
       "      <td>4.0</td>\n",
       "      <td>-0.100175</td>\n",
       "      <td>-0.107606</td>\n",
       "      <td>-0.045338</td>\n",
       "      <td>-0.105555</td>\n",
       "      <td>-0.113848</td>\n",
       "      <td>3040.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2009-02-27</th>\n",
       "      <td>88742</td>\n",
       "      <td>4813.0</td>\n",
       "      <td>21.15</td>\n",
       "      <td>-0.132486</td>\n",
       "      <td>23625.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>-0.100175</td>\n",
       "      <td>-0.107606</td>\n",
       "      <td>-0.142124</td>\n",
       "      <td>-0.105555</td>\n",
       "      <td>-0.113848</td>\n",
       "      <td>499668.75</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2009-02-27</th>\n",
       "      <td>88820</td>\n",
       "      <td>6798.0</td>\n",
       "      <td>15.65</td>\n",
       "      <td>-0.288636</td>\n",
       "      <td>8299.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>-0.100175</td>\n",
       "      <td>-0.107606</td>\n",
       "      <td>-0.340571</td>\n",
       "      <td>-0.105555</td>\n",
       "      <td>-0.113848</td>\n",
       "      <td>129879.35</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2011-12-30</th>\n",
       "      <td>92336</td>\n",
       "      <td>6726.0</td>\n",
       "      <td>108.23</td>\n",
       "      <td>0.017422</td>\n",
       "      <td>900.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.003671</td>\n",
       "      <td>-0.003561</td>\n",
       "      <td>0.017272</td>\n",
       "      <td>0.003664</td>\n",
       "      <td>-0.003567</td>\n",
       "      <td>97407.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2011-12-30</th>\n",
       "      <td>81541</td>\n",
       "      <td>6035.0</td>\n",
       "      <td>17.10</td>\n",
       "      <td>0.007067</td>\n",
       "      <td>54664.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.003671</td>\n",
       "      <td>-0.003561</td>\n",
       "      <td>0.007042</td>\n",
       "      <td>0.003664</td>\n",
       "      <td>-0.003567</td>\n",
       "      <td>934754.40</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2011-12-30</th>\n",
       "      <td>92490</td>\n",
       "      <td>6726.0</td>\n",
       "      <td>34.76</td>\n",
       "      <td>-0.033912</td>\n",
       "      <td>35400.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.003671</td>\n",
       "      <td>-0.003561</td>\n",
       "      <td>-0.034500</td>\n",
       "      <td>0.003664</td>\n",
       "      <td>-0.003567</td>\n",
       "      <td>1230504.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2011-12-30</th>\n",
       "      <td>77090</td>\n",
       "      <td>4813.0</td>\n",
       "      <td>39.05</td>\n",
       "      <td>-0.051208</td>\n",
       "      <td>15383.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.003671</td>\n",
       "      <td>-0.003561</td>\n",
       "      <td>-0.052566</td>\n",
       "      <td>0.003664</td>\n",
       "      <td>-0.003567</td>\n",
       "      <td>600706.15</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2011-12-30</th>\n",
       "      <td>89901</td>\n",
       "      <td>1311.0</td>\n",
       "      <td>46.69</td>\n",
       "      <td>0.003870</td>\n",
       "      <td>117381.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.003671</td>\n",
       "      <td>-0.003561</td>\n",
       "      <td>0.003863</td>\n",
       "      <td>0.003664</td>\n",
       "      <td>-0.003567</td>\n",
       "      <td>5480518.89</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>230324 rows × 12 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "            permno   siccd     prc       ret    shrout  spread    vwretd  \\\n",
       "date                                                                       \n",
       "2009-02-27   80485  2830.0    4.03 -0.179226   69667.0     NaN -0.100175   \n",
       "2009-02-27   89403  4941.0   19.92 -0.081181   29385.0     NaN -0.100175   \n",
       "2009-02-27   92740  6726.0   15.20 -0.044326     200.0     4.0 -0.100175   \n",
       "2009-02-27   88742  4813.0   21.15 -0.132486   23625.0     NaN -0.100175   \n",
       "2009-02-27   88820  6798.0   15.65 -0.288636    8299.0     NaN -0.100175   \n",
       "...            ...     ...     ...       ...       ...     ...       ...   \n",
       "2011-12-30   92336  6726.0  108.23  0.017422     900.0     NaN  0.003671   \n",
       "2011-12-30   81541  6035.0   17.10  0.007067   54664.0     NaN  0.003671   \n",
       "2011-12-30   92490  6726.0   34.76 -0.033912   35400.0     NaN  0.003671   \n",
       "2011-12-30   77090  4813.0   39.05 -0.051208   15383.0     NaN  0.003671   \n",
       "2011-12-30   89901  1311.0   46.69  0.003870  117381.0     NaN  0.003671   \n",
       "\n",
       "              ewretd      lret   lvwretd   lewretd        size  \n",
       "date                                                            \n",
       "2009-02-27 -0.107606 -0.197507 -0.105555 -0.113848   280758.01  \n",
       "2009-02-27 -0.107606 -0.084666 -0.105555 -0.113848   585349.20  \n",
       "2009-02-27 -0.107606 -0.045338 -0.105555 -0.113848     3040.00  \n",
       "2009-02-27 -0.107606 -0.142124 -0.105555 -0.113848   499668.75  \n",
       "2009-02-27 -0.107606 -0.340571 -0.105555 -0.113848   129879.35  \n",
       "...              ...       ...       ...       ...         ...  \n",
       "2011-12-30 -0.003561  0.017272  0.003664 -0.003567    97407.00  \n",
       "2011-12-30 -0.003561  0.007042  0.003664 -0.003567   934754.40  \n",
       "2011-12-30 -0.003561 -0.034500  0.003664 -0.003567  1230504.00  \n",
       "2011-12-30 -0.003561 -0.052566  0.003664 -0.003567   600706.15  \n",
       "2011-12-30 -0.003561  0.003863  0.003664 -0.003567  5480518.89  \n",
       "\n",
       "[230324 rows x 12 columns]"
      ]
     },
     "execution_count": 19,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "crsp_t"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 20,
   "metadata": {
    "papermill": {
     "duration": 0.066245,
     "end_time": "2021-01-21T14:11:27.618463",
     "exception": false,
     "start_time": "2021-01-21T14:11:27.552218",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "# We only want to keep stocks that are there during the full formation window\n",
    "\n",
    "crsp_t['N'] = crsp_t.groupby(['permno'])['permno'].transform('count')\n",
    "\n",
    "# Filter on number of observations. We only keep sotcks for which we have returns\n",
    "# over the full observation period.\n",
    "crsp_t = crsp_t[crsp_t['N'] >= form_period]\n"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "papermill": {
     "duration": 0.050753,
     "end_time": "2021-01-21T14:11:27.720792",
     "exception": false,
     "start_time": "2021-01-21T14:11:27.670039",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "[HERE](https://pbpython.com/pandas_transform.html) for more details on the transform method in Pandas."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 21,
   "metadata": {
    "papermill": {
     "duration": 0.063181,
     "end_time": "2021-01-21T14:11:27.835230",
     "exception": false,
     "start_time": "2021-01-21T14:11:27.772049",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "# Now for each stock we want to compute the full period return.\n",
    "stock_ret = crsp_t.groupby('permno')[['lret', 'lvwretd', 'lewretd']].sum()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 22,
   "metadata": {
    "papermill": {
     "duration": 0.065356,
     "end_time": "2021-01-21T14:11:27.953781",
     "exception": false,
     "start_time": "2021-01-21T14:11:27.888425",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>lret</th>\n",
       "      <th>lvwretd</th>\n",
       "      <th>lewretd</th>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>permno</th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "Empty DataFrame\n",
       "Columns: [lret, lvwretd, lewretd]\n",
       "Index: []"
      ]
     },
     "execution_count": 22,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "stock_ret.head()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 23,
   "metadata": {
    "papermill": {
     "duration": 0.061738,
     "end_time": "2021-01-21T14:11:28.067627",
     "exception": false,
     "start_time": "2021-01-21T14:11:28.005889",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "# Next compute excess returns based on the chosen index.\n",
    "# Note that since the benchmark is the same for all stocks, we could use\n",
    "# actual returns for ranking purposes. It would only make a difference in some\n",
    "### cases. Which ones?\n",
    "\n",
    "stock_ret['lexret'] = stock_ret['lret'] - stock_ret['l' + benchmark]"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 24,
   "metadata": {
    "papermill": {
     "duration": 0.065761,
     "end_time": "2021-01-21T14:11:28.185817",
     "exception": false,
     "start_time": "2021-01-21T14:11:28.120056",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "# Now rankings.\n",
    "\n",
    "stock_ret['rank_asc'] = stock_ret['lexret'].rank() # (1 = worst return)\n",
    "stock_ret['rank_inv'] = stock_ret['lexret'].rank(ascending=False) # (1= best return)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 25,
   "metadata": {
    "papermill": {
     "duration": 0.071072,
     "end_time": "2021-01-21T14:11:28.309390",
     "exception": false,
     "start_time": "2021-01-21T14:11:28.238318",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>lret</th>\n",
       "      <th>lvwretd</th>\n",
       "      <th>lewretd</th>\n",
       "      <th>lexret</th>\n",
       "      <th>rank_asc</th>\n",
       "      <th>rank_inv</th>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>permno</th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "Empty DataFrame\n",
       "Columns: [lret, lvwretd, lewretd, lexret, rank_asc, rank_inv]\n",
       "Index: []"
      ]
     },
     "execution_count": 25,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "stock_ret"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "papermill": {
     "duration": 0.053748,
     "end_time": "2021-01-21T14:11:28.417927",
     "exception": false,
     "start_time": "2021-01-21T14:11:28.364179",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "** rank_asc + rank_inv should give us the total number of securities for a formation date, why is it not the case?"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 26,
   "metadata": {
    "papermill": {
     "duration": 0.076581,
     "end_time": "2021-01-21T14:11:28.577835",
     "exception": false,
     "start_time": "2021-01-21T14:11:28.501254",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "# Assign stock to top or bottom portfolio\n",
    "\n",
    "top_portfolio = stock_ret[stock_ret.rank_inv <= n_stocks].reset_index()[['permno', 'lexret']]\n",
    "bottom_portfolio = stock_ret[stock_ret.rank_asc <= n_stocks].reset_index()[['permno', 'lexret']]\n",
    "    "
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "papermill": {
     "duration": 0.053483,
     "end_time": "2021-01-21T14:11:28.701420",
     "exception": false,
     "start_time": "2021-01-21T14:11:28.647937",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "** why do we set index on permno and log excess returns?"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 27,
   "metadata": {
    "papermill": {
     "duration": 0.072342,
     "end_time": "2021-01-21T14:11:28.826985",
     "exception": false,
     "start_time": "2021-01-21T14:11:28.754643",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>permno</th>\n",
       "      <th>lexret</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "Empty DataFrame\n",
       "Columns: [permno, lexret]\n",
       "Index: []"
      ]
     },
     "execution_count": 27,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "top_portfolio.head()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 28,
   "metadata": {
    "papermill": {
     "duration": 0.065961,
     "end_time": "2021-01-21T14:11:28.953491",
     "exception": false,
     "start_time": "2021-01-21T14:11:28.887530",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>permno</th>\n",
       "      <th>lexret</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "Empty DataFrame\n",
       "Columns: [permno, lexret]\n",
       "Index: []"
      ]
     },
     "execution_count": 28,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "bottom_portfolio.head()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "papermill": {
     "duration": 0.053467,
     "end_time": "2021-01-21T14:11:29.061949",
     "exception": false,
     "start_time": "2021-01-21T14:11:29.008482",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "<a id=\"subsection-three-one-two\"></a>\n",
    "## 3.1.2 Constructing portfolios on each date (N instances) with a function (Key idea #2)\n",
    "\n",
    "Now that we have the code working for one date, we need to run it on each date. Now it's time to generate generalize from 1 instance to N instances with a function."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 29,
   "metadata": {},
   "outputs": [],
   "source": [
    "def compute_performance_portfolios(\n",
    "    date, df, form_period=36, n_stocks=35, benchmark=\"ewretd\", partition=\"permno\"\n",
    "):\n",
    "    \"\"\"\n",
    "    Function computes the performance portfolios, separated into bottom and top performing portfolios\n",
    "    \n",
    "    Parameters:\n",
    "        date (np.datetime): The date at which to start looking\n",
    "        df (pandas.DataFrame): dataframe source \n",
    "        form_period (int): the number of months used to lookback and form the portfolio\n",
    "        n_stocks (int): the number of stocks to form the portfolio \n",
    "        benchmark (str): the benchmark used, either value weighted or equal weighted. See column name in df\n",
    "        partition (str): type of partition to be used\n",
    "    Returns:\n",
    "        tuple: tuple containing the bottom and top portfolios\n",
    "    \"\"\"\n",
    "    beg_dt = (\n",
    "        date - pd.offsets.MonthEnd(1) * form_period\n",
    "    )  # find 36months before the first date\n",
    "    end_dt = date - pd.offsets.MonthEnd(1)\n",
    "    # Select obs for the formation period\n",
    "    crsp_t = df[beg_dt:end_dt].copy()\n",
    "    # We only want to keep stocks that are there during the full formation window\n",
    "    crsp_t[\"N\"] = crsp_t.groupby([partition])[partition].transform(\"count\")\n",
    "    max_form = max(crsp_t[\"N\"])\n",
    "\n",
    "    # Filter on number of observations. We only keep stocks for which we have returns\n",
    "    # over the full observation period.\n",
    "    crsp_t = crsp_t[crsp_t[\"N\"] >= form_period]\n",
    "    if len(crsp_t) == 0:\n",
    "        end_dt = date + pd.offsets.MonthBegin(1)\n",
    "        crsp_t = df[beg_dt:end_dt].copy()\n",
    "        crsp_t[\"N\"] = crsp_t.groupby([partition])[partition].transform(\"count\")\n",
    "        crsp_t = crsp_t[crsp_t[\"N\"] >= form_period]\n",
    "\n",
    "    # Now for each stock we want to compute the full period return. Easy with log returns, just sum up!\n",
    "    stock_ret = crsp_t.groupby(partition)[[\"lret\", \"lvwretd\", \"lewretd\"]].sum()\n",
    "\n",
    "    # Next compute excess returns based on the chosen index.\n",
    "    # Note that since the benchmark is the same for all stocks, we could use\n",
    "    # actual returns for ranking purposes.\n",
    "    stock_ret[\"lexret\"] = stock_ret[\"lret\"] - stock_ret[\"l\" + benchmark]\n",
    "\n",
    "    # Now rankings.\n",
    "    stock_ret[\"rank_asc\"] = stock_ret[\"lexret\"].rank()  # (1 = worst return)\n",
    "    stock_ret[\"rank_inv\"] = stock_ret[\"lexret\"].rank(\n",
    "        ascending=False\n",
    "    )  # (1= best return)\n",
    "\n",
    "    # Assign stock to top or bottom portfolio\n",
    "    top_portfolio = stock_ret[stock_ret.rank_inv <= n_stocks].reset_index()[\n",
    "        [partition, \"lexret\"]\n",
    "    ]\n",
    "    bottom_portfolio = stock_ret[stock_ret.rank_asc <= n_stocks].reset_index()[\n",
    "        [partition, \"lexret\"]\n",
    "    ]\n",
    "\n",
    "    return (bottom_portfolio, top_portfolio)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "papermill": {
     "duration": 0.053947,
     "end_time": "2021-01-21T14:11:29.290287",
     "exception": false,
     "start_time": "2021-01-21T14:11:29.236340",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "** What do the arguments date, df, form_period, n_stocks, and benchmark contain?  \n",
    "** What object type does the function returns with \"(bottom_portfolio, top_portfolio)\"?"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "papermill": {
     "duration": 0.053844,
     "end_time": "2021-01-21T14:11:29.399226",
     "exception": false,
     "start_time": "2021-01-21T14:11:29.345382",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "[HERE](http://https://www.w3schools.com/python/python_tuples.asp) for more details on Python Tuple."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 30,
   "metadata": {
    "papermill": {
     "duration": 0.637982,
     "end_time": "2021-01-21T14:11:30.091458",
     "exception": false,
     "start_time": "2021-01-21T14:11:29.453476",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "portfolios = {}\n",
    "for date in dates:\n",
    "    portfolios[date] = compute_performance_portfolios(date, df_crsp, benchmark=\"ewretd\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "papermill": {
     "duration": 0.055297,
     "end_time": "2021-01-21T14:11:30.201552",
     "exception": false,
     "start_time": "2021-01-21T14:11:30.146255",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "** What is this line of code \"portfolios = {}\" for?  \n",
    "** What does dictionary \"portfolios contain?  \n",
    "** What is the key of the dictionary \"portfolios?  \n",
    "** What are the values that each key in the dictionary \"portfolios?"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 31,
   "metadata": {
    "papermill": {
     "duration": 0.063663,
     "end_time": "2021-01-21T14:11:30.320318",
     "exception": false,
     "start_time": "2021-01-21T14:11:30.256655",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/plain": [
       "dict"
      ]
     },
     "execution_count": 31,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "type(portfolios)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 32,
   "metadata": {
    "papermill": {
     "duration": 0.063569,
     "end_time": "2021-01-21T14:11:30.438684",
     "exception": false,
     "start_time": "2021-01-21T14:11:30.375115",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/plain": [
       "dict_keys([Timestamp('2012-01-31 00:00:00', freq='36M'), Timestamp('2015-01-31 00:00:00', freq='36M'), Timestamp('2018-01-31 00:00:00', freq='36M')])"
      ]
     },
     "execution_count": 32,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "portfolios.keys()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "papermill": {
     "duration": 0.174445,
     "end_time": "2021-01-21T14:11:30.675258",
     "exception": false,
     "start_time": "2021-01-21T14:11:30.500813",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "Check out the values associated with each dictionary key with \"portfolios.values()\" -- Warning long output, but useful to understand the data structure"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 33,
   "metadata": {
    "papermill": {
     "duration": 0.06993,
     "end_time": "2021-01-21T14:11:30.802475",
     "exception": false,
     "start_time": "2021-01-21T14:11:30.732545",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>permno</th>\n",
       "      <th>lexret</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>11182</td>\n",
       "      <td>-4.299902</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>12500</td>\n",
       "      <td>-10.819978</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>12579</td>\n",
       "      <td>-4.543111</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>13013</td>\n",
       "      <td>-8.155369</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>13030</td>\n",
       "      <td>-7.517432</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "   permno     lexret\n",
       "0   11182  -4.299902\n",
       "1   12500 -10.819978\n",
       "2   12579  -4.543111\n",
       "3   13013  -8.155369\n",
       "4   13030  -7.517432"
      ]
     },
     "execution_count": 33,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "portfolios[date][0].head()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 34,
   "metadata": {
    "papermill": {
     "duration": 0.076122,
     "end_time": "2021-01-21T14:11:30.935729",
     "exception": false,
     "start_time": "2021-01-21T14:11:30.859607",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>permno</th>\n",
       "      <th>lexret</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>10966</td>\n",
       "      <td>1.816982</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>12226</td>\n",
       "      <td>1.484895</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>12339</td>\n",
       "      <td>1.572539</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>12497</td>\n",
       "      <td>1.453154</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>13933</td>\n",
       "      <td>1.590277</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "   permno    lexret\n",
       "0   10966  1.816982\n",
       "1   12226  1.484895\n",
       "2   12339  1.572539\n",
       "3   12497  1.453154\n",
       "4   13933  1.590277"
      ]
     },
     "execution_count": 34,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "portfolios[date][1].head()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "papermill": {
     "duration": 0.058161,
     "end_time": "2021-01-21T14:11:31.052150",
     "exception": false,
     "start_time": "2021-01-21T14:11:30.993989",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "<a id=\"subsection-three-two\"></a>\n",
    "## 3.2 Question 2: How do we construct holding period returns?\n",
    "\n",
    "Next, we want to compute cumulative abnormal returns for portfolios during the holding period. First, we do it for one portfolio/date, then we generalize it with a function for each portfolio/date."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "papermill": {
     "duration": 0.058074,
     "end_time": "2021-01-21T14:11:31.168397",
     "exception": false,
     "start_time": "2021-01-21T14:11:31.110323",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "<a id=\"subsection-three-two-one\"></a>\n",
    "## 3.2.1 Constructing portfolios on a single portfolio/date (1 instance)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 35,
   "metadata": {
    "papermill": {
     "duration": 0.066234,
     "end_time": "2021-01-21T14:11:31.293352",
     "exception": false,
     "start_time": "2021-01-21T14:11:31.227118",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "date = dates[0]\n",
    "portfolio = portfolios[date][0] # Bottom portfolio.\n",
    "\n",
    "hold_period = 36 # Holding period, in months\n",
    "benchmark = 'ewretd' # 'vwretd' or 'ewretd'\n",
    "weighting = 'ew' # 'vw' or 'ew'\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 36,
   "metadata": {
    "papermill": {
     "duration": 0.06669,
     "end_time": "2021-01-21T14:11:31.418180",
     "exception": false,
     "start_time": "2021-01-21T14:11:31.351490",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "portfolio = portfolio.copy()\n",
    "end_dt = date + pd.offsets.MonthBegin(1) * hold_period\n",
    "\n",
    "# Select obs for the formation period\n",
    "crsp_t2 = df_crsp[date:end_dt].copy()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "papermill": {
     "duration": 0.061744,
     "end_time": "2021-01-21T14:11:31.537733",
     "exception": false,
     "start_time": "2021-01-21T14:11:31.475989",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "** To get end_dt, why do we add, instead of minus (like before), pd.offsets.MonthBegin(1) * hold_period?  \n",
    "** Why is it \"crsp_t2 = df_crsp[date:end_dt].copy()\" instead of \"crsp_t = df_crsp[beg_dt:date].copy()\" now?  "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 37,
   "metadata": {
    "papermill": {
     "duration": 0.073654,
     "end_time": "2021-01-21T14:11:31.668927",
     "exception": false,
     "start_time": "2021-01-21T14:11:31.595273",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "<class 'pandas.core.frame.DataFrame'>\n",
      "RangeIndex: 35 entries, 0 to 34\n",
      "Data columns (total 2 columns):\n",
      " #   Column  Non-Null Count  Dtype  \n",
      "---  ------  --------------  -----  \n",
      " 0   permno  35 non-null     int64  \n",
      " 1   lexret  35 non-null     float64\n",
      "dtypes: float64(1), int64(1)\n",
      "memory usage: 688.0 bytes\n"
     ]
    }
   ],
   "source": [
    "portfolio.info()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 38,
   "metadata": {
    "papermill": {
     "duration": 0.082329,
     "end_time": "2021-01-21T14:11:31.811950",
     "exception": false,
     "start_time": "2021-01-21T14:11:31.729621",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>permno</th>\n",
       "      <th>siccd</th>\n",
       "      <th>prc</th>\n",
       "      <th>ret</th>\n",
       "      <th>shrout</th>\n",
       "      <th>spread</th>\n",
       "      <th>vwretd</th>\n",
       "      <th>ewretd</th>\n",
       "      <th>lret</th>\n",
       "      <th>lvwretd</th>\n",
       "      <th>lewretd</th>\n",
       "      <th>size</th>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>date</th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>2012-01-31</th>\n",
       "      <td>12856</td>\n",
       "      <td>6726.0</td>\n",
       "      <td>21.162</td>\n",
       "      <td>0.067171</td>\n",
       "      <td>50.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.054140</td>\n",
       "      <td>0.085342</td>\n",
       "      <td>0.065011</td>\n",
       "      <td>0.052725</td>\n",
       "      <td>0.081895</td>\n",
       "      <td>1058.10</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2012-01-31</th>\n",
       "      <td>79689</td>\n",
       "      <td>3820.0</td>\n",
       "      <td>1.920</td>\n",
       "      <td>0.043478</td>\n",
       "      <td>20594.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.054140</td>\n",
       "      <td>0.085342</td>\n",
       "      <td>0.042559</td>\n",
       "      <td>0.052725</td>\n",
       "      <td>0.081895</td>\n",
       "      <td>39540.48</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2012-01-31</th>\n",
       "      <td>13017</td>\n",
       "      <td>6726.0</td>\n",
       "      <td>80.465</td>\n",
       "      <td>0.008965</td>\n",
       "      <td>100.0</td>\n",
       "      <td>0.29</td>\n",
       "      <td>0.054140</td>\n",
       "      <td>0.085342</td>\n",
       "      <td>0.008925</td>\n",
       "      <td>0.052725</td>\n",
       "      <td>0.081895</td>\n",
       "      <td>8046.50</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2012-01-31</th>\n",
       "      <td>93283</td>\n",
       "      <td>6726.0</td>\n",
       "      <td>38.890</td>\n",
       "      <td>-0.317000</td>\n",
       "      <td>350.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.054140</td>\n",
       "      <td>0.085342</td>\n",
       "      <td>-0.381260</td>\n",
       "      <td>0.052725</td>\n",
       "      <td>0.081895</td>\n",
       "      <td>13611.50</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2012-01-31</th>\n",
       "      <td>77776</td>\n",
       "      <td>6726.0</td>\n",
       "      <td>22.000</td>\n",
       "      <td>0.072647</td>\n",
       "      <td>22782.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.054140</td>\n",
       "      <td>0.085342</td>\n",
       "      <td>0.070129</td>\n",
       "      <td>0.052725</td>\n",
       "      <td>0.081895</td>\n",
       "      <td>501204.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2014-12-31</th>\n",
       "      <td>52396</td>\n",
       "      <td>3714.0</td>\n",
       "      <td>19.790</td>\n",
       "      <td>0.102097</td>\n",
       "      <td>26630.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>-0.003661</td>\n",
       "      <td>-0.000181</td>\n",
       "      <td>0.097215</td>\n",
       "      <td>-0.003668</td>\n",
       "      <td>-0.000181</td>\n",
       "      <td>527007.70</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2014-12-31</th>\n",
       "      <td>51423</td>\n",
       "      <td>7011.0</td>\n",
       "      <td>18.510</td>\n",
       "      <td>0.124544</td>\n",
       "      <td>18662.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>-0.003661</td>\n",
       "      <td>-0.000181</td>\n",
       "      <td>0.117378</td>\n",
       "      <td>-0.003668</td>\n",
       "      <td>-0.000181</td>\n",
       "      <td>345433.62</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2014-12-31</th>\n",
       "      <td>89428</td>\n",
       "      <td>6022.0</td>\n",
       "      <td>57.080</td>\n",
       "      <td>-0.079948</td>\n",
       "      <td>1216670.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>-0.003661</td>\n",
       "      <td>-0.000181</td>\n",
       "      <td>-0.083325</td>\n",
       "      <td>-0.003668</td>\n",
       "      <td>-0.000181</td>\n",
       "      <td>69447523.60</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2014-12-31</th>\n",
       "      <td>90756</td>\n",
       "      <td>3711.0</td>\n",
       "      <td>48.650</td>\n",
       "      <td>0.071586</td>\n",
       "      <td>78128.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>-0.003661</td>\n",
       "      <td>-0.000181</td>\n",
       "      <td>0.069140</td>\n",
       "      <td>-0.003668</td>\n",
       "      <td>-0.000181</td>\n",
       "      <td>3800927.20</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2014-12-31</th>\n",
       "      <td>12884</td>\n",
       "      <td>9999.0</td>\n",
       "      <td>16.320</td>\n",
       "      <td>0.094251</td>\n",
       "      <td>16026.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>-0.003661</td>\n",
       "      <td>-0.000181</td>\n",
       "      <td>0.090070</td>\n",
       "      <td>-0.003668</td>\n",
       "      <td>-0.000181</td>\n",
       "      <td>261544.32</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>242802 rows × 12 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "            permno   siccd     prc       ret     shrout  spread    vwretd  \\\n",
       "date                                                                        \n",
       "2012-01-31   12856  6726.0  21.162  0.067171       50.0     NaN  0.054140   \n",
       "2012-01-31   79689  3820.0   1.920  0.043478    20594.0     NaN  0.054140   \n",
       "2012-01-31   13017  6726.0  80.465  0.008965      100.0    0.29  0.054140   \n",
       "2012-01-31   93283  6726.0  38.890 -0.317000      350.0     NaN  0.054140   \n",
       "2012-01-31   77776  6726.0  22.000  0.072647    22782.0     NaN  0.054140   \n",
       "...            ...     ...     ...       ...        ...     ...       ...   \n",
       "2014-12-31   52396  3714.0  19.790  0.102097    26630.0     NaN -0.003661   \n",
       "2014-12-31   51423  7011.0  18.510  0.124544    18662.0     NaN -0.003661   \n",
       "2014-12-31   89428  6022.0  57.080 -0.079948  1216670.0     NaN -0.003661   \n",
       "2014-12-31   90756  3711.0  48.650  0.071586    78128.0     NaN -0.003661   \n",
       "2014-12-31   12884  9999.0  16.320  0.094251    16026.0     NaN -0.003661   \n",
       "\n",
       "              ewretd      lret   lvwretd   lewretd         size  \n",
       "date                                                             \n",
       "2012-01-31  0.085342  0.065011  0.052725  0.081895      1058.10  \n",
       "2012-01-31  0.085342  0.042559  0.052725  0.081895     39540.48  \n",
       "2012-01-31  0.085342  0.008925  0.052725  0.081895      8046.50  \n",
       "2012-01-31  0.085342 -0.381260  0.052725  0.081895     13611.50  \n",
       "2012-01-31  0.085342  0.070129  0.052725  0.081895    501204.00  \n",
       "...              ...       ...       ...       ...          ...  \n",
       "2014-12-31 -0.000181  0.097215 -0.003668 -0.000181    527007.70  \n",
       "2014-12-31 -0.000181  0.117378 -0.003668 -0.000181    345433.62  \n",
       "2014-12-31 -0.000181 -0.083325 -0.003668 -0.000181  69447523.60  \n",
       "2014-12-31 -0.000181  0.069140 -0.003668 -0.000181   3800927.20  \n",
       "2014-12-31 -0.000181  0.090070 -0.003668 -0.000181    261544.32  \n",
       "\n",
       "[242802 rows x 12 columns]"
      ]
     },
     "execution_count": 38,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "crsp_t2"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 39,
   "metadata": {
    "papermill": {
     "duration": 0.083896,
     "end_time": "2021-01-21T14:11:31.955263",
     "exception": false,
     "start_time": "2021-01-21T14:11:31.871367",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "# Merge with stocks in portfolios, to keep only those stocks\n",
    "crsp_t2 = pd.merge(crsp_t2.reset_index(), portfolio, on=['permno'])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 40,
   "metadata": {
    "papermill": {
     "duration": 0.08556,
     "end_time": "2021-01-21T14:11:32.100892",
     "exception": false,
     "start_time": "2021-01-21T14:11:32.015332",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>date</th>\n",
       "      <th>permno</th>\n",
       "      <th>siccd</th>\n",
       "      <th>prc</th>\n",
       "      <th>ret</th>\n",
       "      <th>shrout</th>\n",
       "      <th>spread</th>\n",
       "      <th>vwretd</th>\n",
       "      <th>ewretd</th>\n",
       "      <th>lret</th>\n",
       "      <th>lvwretd</th>\n",
       "      <th>lewretd</th>\n",
       "      <th>size</th>\n",
       "      <th>lexret</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>2012-01-31</td>\n",
       "      <td>92813</td>\n",
       "      <td>6726.0</td>\n",
       "      <td>29.9000</td>\n",
       "      <td>-0.199357</td>\n",
       "      <td>38582.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.054140</td>\n",
       "      <td>0.085342</td>\n",
       "      <td>-0.222340</td>\n",
       "      <td>0.052725</td>\n",
       "      <td>0.081895</td>\n",
       "      <td>1.153602e+06</td>\n",
       "      <td>-5.168006</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>2012-02-29</td>\n",
       "      <td>92813</td>\n",
       "      <td>6726.0</td>\n",
       "      <td>25.5200</td>\n",
       "      <td>-0.146488</td>\n",
       "      <td>36232.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.041253</td>\n",
       "      <td>0.036494</td>\n",
       "      <td>-0.158396</td>\n",
       "      <td>0.040425</td>\n",
       "      <td>0.035844</td>\n",
       "      <td>9.246406e+05</td>\n",
       "      <td>-5.168006</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>2012-03-30</td>\n",
       "      <td>92813</td>\n",
       "      <td>6726.0</td>\n",
       "      <td>20.6500</td>\n",
       "      <td>-0.190831</td>\n",
       "      <td>37082.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.024039</td>\n",
       "      <td>0.017608</td>\n",
       "      <td>-0.211747</td>\n",
       "      <td>0.023755</td>\n",
       "      <td>0.017455</td>\n",
       "      <td>7.657433e+05</td>\n",
       "      <td>-5.168006</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>2012-04-30</td>\n",
       "      <td>92813</td>\n",
       "      <td>6726.0</td>\n",
       "      <td>21.1800</td>\n",
       "      <td>0.025666</td>\n",
       "      <td>32681.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>-0.006840</td>\n",
       "      <td>-0.009106</td>\n",
       "      <td>0.025342</td>\n",
       "      <td>-0.006864</td>\n",
       "      <td>-0.009148</td>\n",
       "      <td>6.921836e+05</td>\n",
       "      <td>-5.168006</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>2012-05-31</td>\n",
       "      <td>92813</td>\n",
       "      <td>6726.0</td>\n",
       "      <td>27.0100</td>\n",
       "      <td>0.275260</td>\n",
       "      <td>25581.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>-0.065641</td>\n",
       "      <td>-0.068418</td>\n",
       "      <td>0.243150</td>\n",
       "      <td>-0.067895</td>\n",
       "      <td>-0.070871</td>\n",
       "      <td>6.909428e+05</td>\n",
       "      <td>-5.168006</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>874</th>\n",
       "      <td>2014-02-28</td>\n",
       "      <td>90743</td>\n",
       "      <td>4412.0</td>\n",
       "      <td>0.6476</td>\n",
       "      <td>-0.405872</td>\n",
       "      <td>48318.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.046225</td>\n",
       "      <td>0.044257</td>\n",
       "      <td>-0.520660</td>\n",
       "      <td>0.045188</td>\n",
       "      <td>0.043306</td>\n",
       "      <td>3.129074e+04</td>\n",
       "      <td>-3.592272</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>875</th>\n",
       "      <td>2014-03-31</td>\n",
       "      <td>90743</td>\n",
       "      <td>4412.0</td>\n",
       "      <td>1.6000</td>\n",
       "      <td>-0.752934</td>\n",
       "      <td>9388.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.004544</td>\n",
       "      <td>0.001028</td>\n",
       "      <td>-1.398100</td>\n",
       "      <td>0.004534</td>\n",
       "      <td>0.001027</td>\n",
       "      <td>1.502080e+04</td>\n",
       "      <td>-3.592272</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>876</th>\n",
       "      <td>2014-04-30</td>\n",
       "      <td>90743</td>\n",
       "      <td>4412.0</td>\n",
       "      <td>0.1100</td>\n",
       "      <td>-0.931250</td>\n",
       "      <td>71999.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.001569</td>\n",
       "      <td>-0.022319</td>\n",
       "      <td>-2.677279</td>\n",
       "      <td>0.001568</td>\n",
       "      <td>-0.022572</td>\n",
       "      <td>7.919890e+03</td>\n",
       "      <td>-3.592272</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>877</th>\n",
       "      <td>2014-05-30</td>\n",
       "      <td>90743</td>\n",
       "      <td>4412.0</td>\n",
       "      <td>1.3800</td>\n",
       "      <td>-0.749091</td>\n",
       "      <td>21139.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.020260</td>\n",
       "      <td>0.006647</td>\n",
       "      <td>-1.382665</td>\n",
       "      <td>0.020057</td>\n",
       "      <td>0.006625</td>\n",
       "      <td>2.917182e+04</td>\n",
       "      <td>-3.592272</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>878</th>\n",
       "      <td>2014-06-30</td>\n",
       "      <td>90743</td>\n",
       "      <td>4412.0</td>\n",
       "      <td>0.2500</td>\n",
       "      <td>-0.818841</td>\n",
       "      <td>144550.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.027991</td>\n",
       "      <td>0.039501</td>\n",
       "      <td>-1.708380</td>\n",
       "      <td>0.027606</td>\n",
       "      <td>0.038741</td>\n",
       "      <td>3.613750e+04</td>\n",
       "      <td>-3.592272</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>879 rows × 14 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "          date  permno   siccd      prc       ret    shrout  spread    vwretd  \\\n",
       "0   2012-01-31   92813  6726.0  29.9000 -0.199357   38582.0     NaN  0.054140   \n",
       "1   2012-02-29   92813  6726.0  25.5200 -0.146488   36232.0     NaN  0.041253   \n",
       "2   2012-03-30   92813  6726.0  20.6500 -0.190831   37082.0     NaN  0.024039   \n",
       "3   2012-04-30   92813  6726.0  21.1800  0.025666   32681.0     NaN -0.006840   \n",
       "4   2012-05-31   92813  6726.0  27.0100  0.275260   25581.0     NaN -0.065641   \n",
       "..         ...     ...     ...      ...       ...       ...     ...       ...   \n",
       "874 2014-02-28   90743  4412.0   0.6476 -0.405872   48318.0     NaN  0.046225   \n",
       "875 2014-03-31   90743  4412.0   1.6000 -0.752934    9388.0     NaN  0.004544   \n",
       "876 2014-04-30   90743  4412.0   0.1100 -0.931250   71999.0     NaN  0.001569   \n",
       "877 2014-05-30   90743  4412.0   1.3800 -0.749091   21139.0     NaN  0.020260   \n",
       "878 2014-06-30   90743  4412.0   0.2500 -0.818841  144550.0     NaN  0.027991   \n",
       "\n",
       "       ewretd      lret   lvwretd   lewretd          size    lexret  \n",
       "0    0.085342 -0.222340  0.052725  0.081895  1.153602e+06 -5.168006  \n",
       "1    0.036494 -0.158396  0.040425  0.035844  9.246406e+05 -5.168006  \n",
       "2    0.017608 -0.211747  0.023755  0.017455  7.657433e+05 -5.168006  \n",
       "3   -0.009106  0.025342 -0.006864 -0.009148  6.921836e+05 -5.168006  \n",
       "4   -0.068418  0.243150 -0.067895 -0.070871  6.909428e+05 -5.168006  \n",
       "..        ...       ...       ...       ...           ...       ...  \n",
       "874  0.044257 -0.520660  0.045188  0.043306  3.129074e+04 -3.592272  \n",
       "875  0.001028 -1.398100  0.004534  0.001027  1.502080e+04 -3.592272  \n",
       "876 -0.022319 -2.677279  0.001568 -0.022572  7.919890e+03 -3.592272  \n",
       "877  0.006647 -1.382665  0.020057  0.006625  2.917182e+04 -3.592272  \n",
       "878  0.039501 -1.708380  0.027606  0.038741  3.613750e+04 -3.592272  \n",
       "\n",
       "[879 rows x 14 columns]"
      ]
     },
     "execution_count": 40,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "crsp_t2"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "papermill": {
     "duration": 0.060351,
     "end_time": "2021-01-21T14:11:32.221068",
     "exception": false,
     "start_time": "2021-01-21T14:11:32.160717",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "** What was the index for crsp_t2 before reset_index()? What is the index now?  \n",
    "** Why has the number of observations gone down from 25011 to 1262?"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 41,
   "metadata": {
    "papermill": {
     "duration": 0.085502,
     "end_time": "2021-01-21T14:11:32.365978",
     "exception": false,
     "start_time": "2021-01-21T14:11:32.280476",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>date</th>\n",
       "      <th>permno</th>\n",
       "      <th>siccd</th>\n",
       "      <th>prc</th>\n",
       "      <th>ret</th>\n",
       "      <th>shrout</th>\n",
       "      <th>spread</th>\n",
       "      <th>vwretd</th>\n",
       "      <th>ewretd</th>\n",
       "      <th>lret</th>\n",
       "      <th>lvwretd</th>\n",
       "      <th>lewretd</th>\n",
       "      <th>size</th>\n",
       "      <th>lexret</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>2012-01-31</td>\n",
       "      <td>92813</td>\n",
       "      <td>6726.0</td>\n",
       "      <td>29.90</td>\n",
       "      <td>-0.199357</td>\n",
       "      <td>38582.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.054140</td>\n",
       "      <td>0.085342</td>\n",
       "      <td>-0.222340</td>\n",
       "      <td>0.052725</td>\n",
       "      <td>0.081895</td>\n",
       "      <td>1153601.80</td>\n",
       "      <td>-5.168006</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>2012-02-29</td>\n",
       "      <td>92813</td>\n",
       "      <td>6726.0</td>\n",
       "      <td>25.52</td>\n",
       "      <td>-0.146488</td>\n",
       "      <td>36232.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.041253</td>\n",
       "      <td>0.036494</td>\n",
       "      <td>-0.158396</td>\n",
       "      <td>0.040425</td>\n",
       "      <td>0.035844</td>\n",
       "      <td>924640.64</td>\n",
       "      <td>-5.168006</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>2012-03-30</td>\n",
       "      <td>92813</td>\n",
       "      <td>6726.0</td>\n",
       "      <td>20.65</td>\n",
       "      <td>-0.190831</td>\n",
       "      <td>37082.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.024039</td>\n",
       "      <td>0.017608</td>\n",
       "      <td>-0.211747</td>\n",
       "      <td>0.023755</td>\n",
       "      <td>0.017455</td>\n",
       "      <td>765743.30</td>\n",
       "      <td>-5.168006</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>2012-04-30</td>\n",
       "      <td>92813</td>\n",
       "      <td>6726.0</td>\n",
       "      <td>21.18</td>\n",
       "      <td>0.025666</td>\n",
       "      <td>32681.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>-0.006840</td>\n",
       "      <td>-0.009106</td>\n",
       "      <td>0.025342</td>\n",
       "      <td>-0.006864</td>\n",
       "      <td>-0.009148</td>\n",
       "      <td>692183.58</td>\n",
       "      <td>-5.168006</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>2012-05-31</td>\n",
       "      <td>92813</td>\n",
       "      <td>6726.0</td>\n",
       "      <td>27.01</td>\n",
       "      <td>0.275260</td>\n",
       "      <td>25581.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>-0.065641</td>\n",
       "      <td>-0.068418</td>\n",
       "      <td>0.243150</td>\n",
       "      <td>-0.067895</td>\n",
       "      <td>-0.070871</td>\n",
       "      <td>690942.81</td>\n",
       "      <td>-5.168006</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "        date  permno   siccd    prc       ret   shrout  spread    vwretd  \\\n",
       "0 2012-01-31   92813  6726.0  29.90 -0.199357  38582.0     NaN  0.054140   \n",
       "1 2012-02-29   92813  6726.0  25.52 -0.146488  36232.0     NaN  0.041253   \n",
       "2 2012-03-30   92813  6726.0  20.65 -0.190831  37082.0     NaN  0.024039   \n",
       "3 2012-04-30   92813  6726.0  21.18  0.025666  32681.0     NaN -0.006840   \n",
       "4 2012-05-31   92813  6726.0  27.01  0.275260  25581.0     NaN -0.065641   \n",
       "\n",
       "     ewretd      lret   lvwretd   lewretd        size    lexret  \n",
       "0  0.085342 -0.222340  0.052725  0.081895  1153601.80 -5.168006  \n",
       "1  0.036494 -0.158396  0.040425  0.035844   924640.64 -5.168006  \n",
       "2  0.017608 -0.211747  0.023755  0.017455   765743.30 -5.168006  \n",
       "3 -0.009106  0.025342 -0.006864 -0.009148   692183.58 -5.168006  \n",
       "4 -0.068418  0.243150 -0.067895 -0.070871   690942.81 -5.168006  "
      ]
     },
     "execution_count": 41,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "crsp_t2.head()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 42,
   "metadata": {
    "papermill": {
     "duration": 0.081484,
     "end_time": "2021-01-21T14:11:32.507588",
     "exception": false,
     "start_time": "2021-01-21T14:11:32.426104",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>date</th>\n",
       "      <th>permno</th>\n",
       "      <th>siccd</th>\n",
       "      <th>prc</th>\n",
       "      <th>ret</th>\n",
       "      <th>shrout</th>\n",
       "      <th>spread</th>\n",
       "      <th>vwretd</th>\n",
       "      <th>ewretd</th>\n",
       "      <th>lret</th>\n",
       "      <th>lvwretd</th>\n",
       "      <th>lewretd</th>\n",
       "      <th>size</th>\n",
       "      <th>lexret</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>874</th>\n",
       "      <td>2014-02-28</td>\n",
       "      <td>90743</td>\n",
       "      <td>4412.0</td>\n",
       "      <td>0.6476</td>\n",
       "      <td>-0.405872</td>\n",
       "      <td>48318.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.046225</td>\n",
       "      <td>0.044257</td>\n",
       "      <td>-0.520660</td>\n",
       "      <td>0.045188</td>\n",
       "      <td>0.043306</td>\n",
       "      <td>31290.7368</td>\n",
       "      <td>-3.592272</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>875</th>\n",
       "      <td>2014-03-31</td>\n",
       "      <td>90743</td>\n",
       "      <td>4412.0</td>\n",
       "      <td>1.6000</td>\n",
       "      <td>-0.752934</td>\n",
       "      <td>9388.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.004544</td>\n",
       "      <td>0.001028</td>\n",
       "      <td>-1.398100</td>\n",
       "      <td>0.004534</td>\n",
       "      <td>0.001027</td>\n",
       "      <td>15020.8000</td>\n",
       "      <td>-3.592272</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>876</th>\n",
       "      <td>2014-04-30</td>\n",
       "      <td>90743</td>\n",
       "      <td>4412.0</td>\n",
       "      <td>0.1100</td>\n",
       "      <td>-0.931250</td>\n",
       "      <td>71999.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.001569</td>\n",
       "      <td>-0.022319</td>\n",
       "      <td>-2.677279</td>\n",
       "      <td>0.001568</td>\n",
       "      <td>-0.022572</td>\n",
       "      <td>7919.8900</td>\n",
       "      <td>-3.592272</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>877</th>\n",
       "      <td>2014-05-30</td>\n",
       "      <td>90743</td>\n",
       "      <td>4412.0</td>\n",
       "      <td>1.3800</td>\n",
       "      <td>-0.749091</td>\n",
       "      <td>21139.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.020260</td>\n",
       "      <td>0.006647</td>\n",
       "      <td>-1.382665</td>\n",
       "      <td>0.020057</td>\n",
       "      <td>0.006625</td>\n",
       "      <td>29171.8200</td>\n",
       "      <td>-3.592272</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>878</th>\n",
       "      <td>2014-06-30</td>\n",
       "      <td>90743</td>\n",
       "      <td>4412.0</td>\n",
       "      <td>0.2500</td>\n",
       "      <td>-0.818841</td>\n",
       "      <td>144550.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.027991</td>\n",
       "      <td>0.039501</td>\n",
       "      <td>-1.708380</td>\n",
       "      <td>0.027606</td>\n",
       "      <td>0.038741</td>\n",
       "      <td>36137.5000</td>\n",
       "      <td>-3.592272</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "          date  permno   siccd     prc       ret    shrout  spread    vwretd  \\\n",
       "874 2014-02-28   90743  4412.0  0.6476 -0.405872   48318.0     NaN  0.046225   \n",
       "875 2014-03-31   90743  4412.0  1.6000 -0.752934    9388.0     NaN  0.004544   \n",
       "876 2014-04-30   90743  4412.0  0.1100 -0.931250   71999.0     NaN  0.001569   \n",
       "877 2014-05-30   90743  4412.0  1.3800 -0.749091   21139.0     NaN  0.020260   \n",
       "878 2014-06-30   90743  4412.0  0.2500 -0.818841  144550.0     NaN  0.027991   \n",
       "\n",
       "       ewretd      lret   lvwretd   lewretd        size    lexret  \n",
       "874  0.044257 -0.520660  0.045188  0.043306  31290.7368 -3.592272  \n",
       "875  0.001028 -1.398100  0.004534  0.001027  15020.8000 -3.592272  \n",
       "876 -0.022319 -2.677279  0.001568 -0.022572   7919.8900 -3.592272  \n",
       "877  0.006647 -1.382665  0.020057  0.006625  29171.8200 -3.592272  \n",
       "878  0.039501 -1.708380  0.027606  0.038741  36137.5000 -3.592272  "
      ]
     },
     "execution_count": 42,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "crsp_t2.tail()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 43,
   "metadata": {
    "papermill": {
     "duration": 0.076738,
     "end_time": "2021-01-21T14:11:32.645157",
     "exception": false,
     "start_time": "2021-01-21T14:11:32.568419",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "[{'date': numpy.datetime64('2012-01-31T00:00:00.000000000'), 'permno': 11018}, {'date': numpy.datetime64('2012-01-31T00:00:00.000000000'), 'permno': 32636}, {'date': numpy.datetime64('2012-01-31T00:00:00.000000000'), 'permno': 59483}, {'date': numpy.datetime64('2012-01-31T00:00:00.000000000'), 'permno': 77437}, {'date': numpy.datetime64('2012-01-31T00:00:00.000000000'), 'permno': 80625}, {'date': numpy.datetime64('2012-01-31T00:00:00.000000000'), 'permno': 83551}, {'date': numpy.datetime64('2012-01-31T00:00:00.000000000'), 'permno': 85047}, {'date': numpy.datetime64('2012-01-31T00:00:00.000000000'), 'permno': 88945}, {'date': numpy.datetime64('2012-01-31T00:00:00.000000000'), 'permno': 89030}, {'date': numpy.datetime64('2012-01-31T00:00:00.000000000'), 'permno': 89452}]\n",
      "<class 'list'>\n",
      "<class 'dict'>\n",
      "35\n"
     ]
    }
   ],
   "source": [
    "# We want to make sure we have one observation for each stock/date.\n",
    "# If a stock is delisted, its returns will be 0 after it disappears,\n",
    "# so we just fill in these missing values.\n",
    "\n",
    "# The idea here is to create a DataFrame with all the permno/date pairs\n",
    "# that we want in the final dataset. Then we merge that list with the\n",
    "# dataset using \"outer\" which will generate missing values for the\n",
    "# pairs that are not in the dataset.\n",
    "\n",
    "# Get the dates in the dataset.\n",
    "pairs_t2 = [{'date': d, 'permno': p} for d in crsp_t2['date'].unique() \n",
    "                                    for p in portfolio['permno'].unique()]\n",
    "print(pairs_t2[:10])\n",
    "print(type(pairs_t2))\n",
    "print(type(pairs_t2[0]))\n",
    "print(len(portfolio))"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "papermill": {
     "duration": 0.060513,
     "end_time": "2021-01-21T14:11:32.774386",
     "exception": false,
     "start_time": "2021-01-21T14:11:32.713873",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "** What is the implication of filling in missing returns with 0?"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 44,
   "metadata": {
    "papermill": {
     "duration": 0.080715,
     "end_time": "2021-01-21T14:11:32.915888",
     "exception": false,
     "start_time": "2021-01-21T14:11:32.835173",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "<class 'pandas.core.frame.DataFrame'>\n",
      "RangeIndex: 1260 entries, 0 to 1259\n",
      "Data columns (total 2 columns):\n",
      " #   Column  Non-Null Count  Dtype         \n",
      "---  ------  --------------  -----         \n",
      " 0   date    1260 non-null   datetime64[ns]\n",
      " 1   permno  1260 non-null   int64         \n",
      "dtypes: datetime64[ns](1), int64(1)\n",
      "memory usage: 19.8 KB\n"
     ]
    }
   ],
   "source": [
    "pairs_t2 = pd.DataFrame(pairs_t2)\n",
    "pairs_t2.info()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 45,
   "metadata": {
    "papermill": {
     "duration": 0.083758,
     "end_time": "2021-01-21T14:11:33.064595",
     "exception": false,
     "start_time": "2021-01-21T14:11:32.980837",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "<class 'pandas.core.frame.DataFrame'>\n",
      "Int64Index: 1260 entries, 0 to 1259\n",
      "Data columns (total 14 columns):\n",
      " #   Column   Non-Null Count  Dtype         \n",
      "---  ------   --------------  -----         \n",
      " 0   date     1260 non-null   datetime64[ns]\n",
      " 1   permno   1260 non-null   int64         \n",
      " 2   siccd    879 non-null    float64       \n",
      " 3   prc      879 non-null    float64       \n",
      " 4   ret      879 non-null    float64       \n",
      " 5   shrout   879 non-null    float64       \n",
      " 6   spread   17 non-null     float64       \n",
      " 7   vwretd   879 non-null    float64       \n",
      " 8   ewretd   879 non-null    float64       \n",
      " 9   lret     879 non-null    float64       \n",
      " 10  lvwretd  879 non-null    float64       \n",
      " 11  lewretd  879 non-null    float64       \n",
      " 12  size     879 non-null    float64       \n",
      " 13  lexret   879 non-null    float64       \n",
      "dtypes: datetime64[ns](1), float64(12), int64(1)\n",
      "memory usage: 147.7 KB\n"
     ]
    }
   ],
   "source": [
    "# Merge to generate placeholders\n",
    "\n",
    "crsp_t2 = pd.merge(crsp_t2, pairs_t2, how='outer', on=['permno', 'date'])\n",
    "crsp_t2.info()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 46,
   "metadata": {
    "papermill": {
     "duration": 0.072786,
     "end_time": "2021-01-21T14:11:33.199256",
     "exception": false,
     "start_time": "2021-01-21T14:11:33.126470",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "# Fill missing values with 0\n",
    "ret_cols = ['ret', 'vwretd', 'ewretd', 'lvwretd','lewretd', 'lret', 'lexret']\n",
    "crsp_t2[ret_cols] = crsp_t2[ret_cols].fillna(0.0)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 47,
   "metadata": {
    "papermill": {
     "duration": 0.075546,
     "end_time": "2021-01-21T14:11:33.338292",
     "exception": false,
     "start_time": "2021-01-21T14:11:33.262746",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "# Now we want the return up to each point in time\n",
    "crsp_t2['lcumret'] = crsp_t2.groupby('permno')['lret'].cumsum()\n",
    "crsp_t2['lcum' + benchmark] = crsp_t2.groupby('permno')['l' + benchmark].cumsum()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 48,
   "metadata": {
    "papermill": {
     "duration": 0.284111,
     "end_time": "2021-01-21T14:11:33.684312",
     "exception": false,
     "start_time": "2021-01-21T14:11:33.400201",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "# At each point in time, the return of the portfolio will be the \n",
    "# cumulative return of each component weighted by the initial weight.\n",
    "# Note that here we need the average (equally- or value-weighted) cumulative return\n",
    "# So, we need to back out the cumulative return from its log form.\n",
    "\n",
    "crsp_t2['cumret'] = np.exp(crsp_t2['lcumret']) - 1\n",
    "crsp_t2['cum' + benchmark] = np.exp(crsp_t2['lcum' + benchmark]) - 1\n",
    "\n",
    "# Add weights, equal weighted is easy.\n",
    "portfolio['ew'] = 1 / len(portfolio)\n",
    "\n",
    "# For value-weighted, need to get size as of formation date.\n",
    "portfolio['date'] = date\n",
    "weights = pd.merge_asof(portfolio, df_crsp[['permno', 'size']],\n",
    "                        by='permno',\n",
    "                        left_on='date',\n",
    "                        right_index=True)\n",
    "weights['vw'] = weights['size'] / weights['size'].sum()\n",
    "\n",
    "del weights['lexret']\n",
    "del weights['date']\n",
    "del weights['size']"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 49,
   "metadata": {
    "papermill": {
     "duration": 0.075549,
     "end_time": "2021-01-21T14:11:33.823277",
     "exception": false,
     "start_time": "2021-01-21T14:11:33.747728",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>permno</th>\n",
       "      <th>ew</th>\n",
       "      <th>vw</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>11018</td>\n",
       "      <td>0.028571</td>\n",
       "      <td>0.121159</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>32636</td>\n",
       "      <td>0.028571</td>\n",
       "      <td>0.010233</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>59483</td>\n",
       "      <td>0.028571</td>\n",
       "      <td>0.016185</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>77437</td>\n",
       "      <td>0.028571</td>\n",
       "      <td>0.004308</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>80625</td>\n",
       "      <td>0.028571</td>\n",
       "      <td>0.054940</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "   permno        ew        vw\n",
       "0   11018  0.028571  0.121159\n",
       "1   32636  0.028571  0.010233\n",
       "2   59483  0.028571  0.016185\n",
       "3   77437  0.028571  0.004308\n",
       "4   80625  0.028571  0.054940"
      ]
     },
     "execution_count": 49,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "weights.head()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 50,
   "metadata": {
    "papermill": {
     "duration": 0.074833,
     "end_time": "2021-01-21T14:11:33.960552",
     "exception": false,
     "start_time": "2021-01-21T14:11:33.885719",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "# Now merge back with returns\n",
    "crsp_t2 = pd.merge(crsp_t2, weights, on='permno')"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 51,
   "metadata": {
    "papermill": {
     "duration": 0.086735,
     "end_time": "2021-01-21T14:11:34.109981",
     "exception": false,
     "start_time": "2021-01-21T14:11:34.023246",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>date</th>\n",
       "      <th>permno</th>\n",
       "      <th>siccd</th>\n",
       "      <th>prc</th>\n",
       "      <th>ret</th>\n",
       "      <th>shrout</th>\n",
       "      <th>spread</th>\n",
       "      <th>vwretd</th>\n",
       "      <th>ewretd</th>\n",
       "      <th>lret</th>\n",
       "      <th>lvwretd</th>\n",
       "      <th>lewretd</th>\n",
       "      <th>size</th>\n",
       "      <th>lexret</th>\n",
       "      <th>lcumret</th>\n",
       "      <th>lcumewretd</th>\n",
       "      <th>cumret</th>\n",
       "      <th>cumewretd</th>\n",
       "      <th>ew</th>\n",
       "      <th>vw</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>2012-01-31</td>\n",
       "      <td>92813</td>\n",
       "      <td>6726.0</td>\n",
       "      <td>29.90</td>\n",
       "      <td>-0.199357</td>\n",
       "      <td>38582.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.054140</td>\n",
       "      <td>0.085342</td>\n",
       "      <td>-0.222340</td>\n",
       "      <td>0.052725</td>\n",
       "      <td>0.081895</td>\n",
       "      <td>1153601.80</td>\n",
       "      <td>-5.168006</td>\n",
       "      <td>-0.222340</td>\n",
       "      <td>0.081895</td>\n",
       "      <td>-0.199357</td>\n",
       "      <td>0.085342</td>\n",
       "      <td>0.028571</td>\n",
       "      <td>0.21938</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>2012-02-29</td>\n",
       "      <td>92813</td>\n",
       "      <td>6726.0</td>\n",
       "      <td>25.52</td>\n",
       "      <td>-0.146488</td>\n",
       "      <td>36232.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.041253</td>\n",
       "      <td>0.036494</td>\n",
       "      <td>-0.158396</td>\n",
       "      <td>0.040425</td>\n",
       "      <td>0.035844</td>\n",
       "      <td>924640.64</td>\n",
       "      <td>-5.168006</td>\n",
       "      <td>-0.380736</td>\n",
       "      <td>0.117739</td>\n",
       "      <td>-0.316642</td>\n",
       "      <td>0.124950</td>\n",
       "      <td>0.028571</td>\n",
       "      <td>0.21938</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>2012-03-30</td>\n",
       "      <td>92813</td>\n",
       "      <td>6726.0</td>\n",
       "      <td>20.65</td>\n",
       "      <td>-0.190831</td>\n",
       "      <td>37082.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.024039</td>\n",
       "      <td>0.017608</td>\n",
       "      <td>-0.211747</td>\n",
       "      <td>0.023755</td>\n",
       "      <td>0.017455</td>\n",
       "      <td>765743.30</td>\n",
       "      <td>-5.168006</td>\n",
       "      <td>-0.592483</td>\n",
       "      <td>0.135194</td>\n",
       "      <td>-0.447048</td>\n",
       "      <td>0.144759</td>\n",
       "      <td>0.028571</td>\n",
       "      <td>0.21938</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>2012-04-30</td>\n",
       "      <td>92813</td>\n",
       "      <td>6726.0</td>\n",
       "      <td>21.18</td>\n",
       "      <td>0.025666</td>\n",
       "      <td>32681.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>-0.006840</td>\n",
       "      <td>-0.009106</td>\n",
       "      <td>0.025342</td>\n",
       "      <td>-0.006864</td>\n",
       "      <td>-0.009148</td>\n",
       "      <td>692183.58</td>\n",
       "      <td>-5.168006</td>\n",
       "      <td>-0.567141</td>\n",
       "      <td>0.126046</td>\n",
       "      <td>-0.432855</td>\n",
       "      <td>0.134334</td>\n",
       "      <td>0.028571</td>\n",
       "      <td>0.21938</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>2012-05-31</td>\n",
       "      <td>92813</td>\n",
       "      <td>6726.0</td>\n",
       "      <td>27.01</td>\n",
       "      <td>0.275260</td>\n",
       "      <td>25581.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>-0.065641</td>\n",
       "      <td>-0.068418</td>\n",
       "      <td>0.243150</td>\n",
       "      <td>-0.067895</td>\n",
       "      <td>-0.070871</td>\n",
       "      <td>690942.81</td>\n",
       "      <td>-5.168006</td>\n",
       "      <td>-0.323991</td>\n",
       "      <td>0.055175</td>\n",
       "      <td>-0.276743</td>\n",
       "      <td>0.056726</td>\n",
       "      <td>0.028571</td>\n",
       "      <td>0.21938</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "        date  permno   siccd    prc       ret   shrout  spread    vwretd  \\\n",
       "0 2012-01-31   92813  6726.0  29.90 -0.199357  38582.0     NaN  0.054140   \n",
       "1 2012-02-29   92813  6726.0  25.52 -0.146488  36232.0     NaN  0.041253   \n",
       "2 2012-03-30   92813  6726.0  20.65 -0.190831  37082.0     NaN  0.024039   \n",
       "3 2012-04-30   92813  6726.0  21.18  0.025666  32681.0     NaN -0.006840   \n",
       "4 2012-05-31   92813  6726.0  27.01  0.275260  25581.0     NaN -0.065641   \n",
       "\n",
       "     ewretd      lret   lvwretd   lewretd        size    lexret   lcumret  \\\n",
       "0  0.085342 -0.222340  0.052725  0.081895  1153601.80 -5.168006 -0.222340   \n",
       "1  0.036494 -0.158396  0.040425  0.035844   924640.64 -5.168006 -0.380736   \n",
       "2  0.017608 -0.211747  0.023755  0.017455   765743.30 -5.168006 -0.592483   \n",
       "3 -0.009106  0.025342 -0.006864 -0.009148   692183.58 -5.168006 -0.567141   \n",
       "4 -0.068418  0.243150 -0.067895 -0.070871   690942.81 -5.168006 -0.323991   \n",
       "\n",
       "   lcumewretd    cumret  cumewretd        ew       vw  \n",
       "0    0.081895 -0.199357   0.085342  0.028571  0.21938  \n",
       "1    0.117739 -0.316642   0.124950  0.028571  0.21938  \n",
       "2    0.135194 -0.447048   0.144759  0.028571  0.21938  \n",
       "3    0.126046 -0.432855   0.134334  0.028571  0.21938  \n",
       "4    0.055175 -0.276743   0.056726  0.028571  0.21938  "
      ]
     },
     "execution_count": 51,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "crsp_t2.head()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 52,
   "metadata": {
    "papermill": {
     "duration": 0.076632,
     "end_time": "2021-01-21T14:11:34.249826",
     "exception": false,
     "start_time": "2021-01-21T14:11:34.173194",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "# Now compute the weighted cumulative return: equally- or value-weighted\n",
    "crsp_t2['wcumret'] = crsp_t2[weighting] * crsp_t2['cumret']\n",
    "crsp_t2['wcum' + benchmark] = crsp_t2[weighting] * crsp_t2['cum' + benchmark]\n",
    "\n",
    "portfolio_ret = crsp_t2.groupby(['date'])[['wcumret', 'wcum' + benchmark]].sum()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 53,
   "metadata": {
    "papermill": {
     "duration": 0.073148,
     "end_time": "2021-01-21T14:11:34.386343",
     "exception": false,
     "start_time": "2021-01-21T14:11:34.313195",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "# Count the months\n",
    "portfolio_ret = portfolio_ret.reset_index()\n",
    "portfolio_ret['months'] = portfolio_ret.index.values + 1"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 54,
   "metadata": {
    "papermill": {
     "duration": 0.074656,
     "end_time": "2021-01-21T14:11:34.525192",
     "exception": false,
     "start_time": "2021-01-21T14:11:34.450536",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "portfolio_ret['exret'] = portfolio_ret['wcumret'] - portfolio_ret['wcum' + benchmark]"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 55,
   "metadata": {
    "papermill": {
     "duration": 0.079601,
     "end_time": "2021-01-21T14:11:34.668545",
     "exception": false,
     "start_time": "2021-01-21T14:11:34.588944",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>date</th>\n",
       "      <th>wcumret</th>\n",
       "      <th>wcumewretd</th>\n",
       "      <th>months</th>\n",
       "      <th>exret</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>2012-01-31</td>\n",
       "      <td>0.176296</td>\n",
       "      <td>0.085342</td>\n",
       "      <td>1</td>\n",
       "      <td>0.090954</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>2012-02-29</td>\n",
       "      <td>0.336930</td>\n",
       "      <td>0.122687</td>\n",
       "      <td>2</td>\n",
       "      <td>0.214243</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>2012-03-30</td>\n",
       "      <td>0.487541</td>\n",
       "      <td>0.140797</td>\n",
       "      <td>3</td>\n",
       "      <td>0.346744</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>2012-04-30</td>\n",
       "      <td>0.515147</td>\n",
       "      <td>0.131862</td>\n",
       "      <td>4</td>\n",
       "      <td>0.383284</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>2012-05-31</td>\n",
       "      <td>0.366925</td>\n",
       "      <td>0.067558</td>\n",
       "      <td>5</td>\n",
       "      <td>0.299367</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "        date   wcumret  wcumewretd  months     exret\n",
       "0 2012-01-31  0.176296    0.085342       1  0.090954\n",
       "1 2012-02-29  0.336930    0.122687       2  0.214243\n",
       "2 2012-03-30  0.487541    0.140797       3  0.346744\n",
       "3 2012-04-30  0.515147    0.131862       4  0.383284\n",
       "4 2012-05-31  0.366925    0.067558       5  0.299367"
      ]
     },
     "execution_count": 55,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "portfolio_ret.head()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "papermill": {
     "duration": 0.06541,
     "end_time": "2021-01-21T14:11:34.799162",
     "exception": false,
     "start_time": "2021-01-21T14:11:34.733752",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "<a id=\"subsection-three-two-two\"></a>\n",
    "## 3.2.2 Computing holding period returns on each portfolio/date (N instances) with a function (Key idea #3)\n",
    "\n",
    "Now that we have the code working for one portfolio/date to compute cumulative abnormal returns for portfolios during the holding period, we will generalize it to run on each portfolio/date with a function."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 56,
   "metadata": {},
   "outputs": [],
   "source": [
    "def compute_holding_returns(date, portfolio, df, benchmark='ewretd', weighting='ew',\n",
    "                            hold_period=36, partition = \"permno\"):\n",
    "    \"\"\"\n",
    "    Function computes the average returns of a given portoflio previously generated by compuete_performance_portfolio() \n",
    "    \n",
    "    Parameters:\n",
    "        date (np.datetime): The date at which to start looking\n",
    "        portfolio (pandas.DataFrame): dataframe slice from compute_performance_portfolio()\n",
    "        df (pandas.DataFrame): original dataframe source \n",
    "        benchmark (str): the benchmark used, either value weighted or equal weighted. See column name in df\n",
    "        weighting (str): either value or equal weighted. \n",
    "        partition (str): type of partition to be used\n",
    "    Returns:\n",
    "        dataframe: portfolio returns \n",
    "    \"\"\"\n",
    "    \n",
    "    port = portfolio.copy()\n",
    "    end_dt = date + pd.offsets.MonthBegin(1) * hold_period\n",
    "    # Select obs for the formation period\n",
    "    crsp_t2 = df[date:end_dt].copy()\n",
    "    # Merge with stocks in portfolios, to keep only those stocks\n",
    "    crsp_t2 = pd.merge(crsp_t2.reset_index(), port, on=[partition])\n",
    "    crsp_t2\n",
    "    \n",
    "\n",
    "    # Get the dates in the dataset.\n",
    "    pairs_t2 = [{'date': d, partition: p} for d in crsp_t2['date'].unique() for p in port[partition].unique()]\n",
    "    pairs_t2 = pd.DataFrame(pairs_t2)\n",
    "    pairs_t2\n",
    "    crsp_t2 = pd.merge(crsp_t2, pairs_t2, how='outer', on=[partition, 'date'])\n",
    "    ret_cols = ['ret', 'vwretd', 'ewretd', 'lvwretd','lewretd', 'lret', 'lexret']\n",
    "    crsp_t2[ret_cols] = crsp_t2[ret_cols].fillna(0.0)\n",
    "    \n",
    "    # Now we want the return up to each point in time\n",
    "    crsp_t2['lcumret'] = crsp_t2.groupby(partition)['lret'].cumsum()\n",
    "    crsp_t2['lcum' + benchmark] = crsp_t2.groupby(partition)['l' + benchmark].cumsum()\n",
    "\n",
    "    # At each point in time, the return of the portfolio will be the \n",
    "    # cumulative return of each component weighted by the initial weight.\n",
    "    # Note that here we need the simple return average, not log return.\n",
    "    crsp_t2['cumret'] = np.exp(crsp_t2['lcumret']) - 1\n",
    "    crsp_t2['cum' + benchmark] = np.exp(crsp_t2['lcum' + benchmark]) - 1\n",
    "\n",
    "    # Add weights, equal weighted is easy.\n",
    "    port['ew'] = 1 / len(port)\n",
    "\n",
    "    # For value-weighted, need to get size as of formation date.\n",
    "    port['date'] = date\n",
    "    weights = pd.merge_asof(port, df[[partition, 'size']],\n",
    "                            by=partition,\n",
    "                            left_on='date',\n",
    "                            right_index=True)\n",
    "    weights['vw'] = weights['size'] / weights['size'].sum()\n",
    "\n",
    "    del weights['lexret']\n",
    "    del weights['date']\n",
    "    del weights['size']\n",
    "    \n",
    "    # Now merge back with returns\n",
    "    crsp_t2 = pd.merge(crsp_t2, weights, on=partition)\n",
    "    \n",
    "    # Now compute the weighted cumulative return \n",
    "    crsp_t2['wcumret'] = crsp_t2[weighting] * crsp_t2['cumret']\n",
    "    crsp_t2['wcum' + benchmark] = crsp_t2[weighting] * crsp_t2['cum' + benchmark]\n",
    "\n",
    "    portfolio_ret = crsp_t2.groupby(['date'])[['wcumret', 'wcum' + benchmark]].sum()\n",
    "    \n",
    "    # Count the months\n",
    "    portfolio_ret = portfolio_ret.reset_index()\n",
    "    portfolio_ret['months'] = portfolio_ret.index.values + 1\n",
    "    \n",
    "    portfolio_ret['exret'] = portfolio_ret['wcumret'] - portfolio_ret['wcum' + benchmark]\n",
    "    \n",
    "    return portfolio_ret"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 57,
   "metadata": {},
   "outputs": [],
   "source": [
    "bottom_portfolio_ret = []\n",
    "top_portfolio_ret = []\n",
    "\n",
    "form_period = 36 # 36 Formation period, in month\n",
    "n_stocks = 35  # Number of stocks in the top and bottom performance\n",
    "hold_period = 36\n",
    "benchmark = 'ewretd' # Benchmark market return to use ('vwretd' or 'ewretd')\n",
    "\n",
    "for date in dates:\n",
    "    bottom_portfolio_ret.append(compute_holding_returns(date, portfolios[date][0], df_crsp, benchmark='ewretd', weighting='ew', hold_period = hold_period))\n",
    "    top_portfolio_ret.append(compute_holding_returns(date, portfolios[date][1], df_crsp, benchmark='ewretd', weighting='ew', hold_period = hold_period))"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "papermill": {
     "duration": 0.065049,
     "end_time": "2021-01-21T14:11:42.981798",
     "exception": false,
     "start_time": "2021-01-21T14:11:42.916749",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "** Which data structures do both bottom_portfolio_ret and top_portfolio_ret belong to?"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 58,
   "metadata": {
    "papermill": {
     "duration": 0.07273,
     "end_time": "2021-01-21T14:11:43.119652",
     "exception": false,
     "start_time": "2021-01-21T14:11:43.046922",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/plain": [
       "list"
      ]
     },
     "execution_count": 58,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "bottom_portfolio_ret\n",
    "type(bottom_portfolio_ret)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "papermill": {
     "duration": 0.06437,
     "end_time": "2021-01-21T14:11:43.248969",
     "exception": false,
     "start_time": "2021-01-21T14:11:43.184599",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "Ops, we have a list of dataframes here. Let's join the dataframes together into a single dataframes."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 59,
   "metadata": {
    "papermill": {
     "duration": 0.097765,
     "end_time": "2021-01-21T14:11:43.411737",
     "exception": false,
     "start_time": "2021-01-21T14:11:43.313972",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "bottom_portfolio_ret = pd.concat(bottom_portfolio_ret)\n",
    "top_portfolio_ret = pd.concat(top_portfolio_ret)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 60,
   "metadata": {
    "papermill": {
     "duration": 0.085235,
     "end_time": "2021-01-21T14:11:43.562055",
     "exception": false,
     "start_time": "2021-01-21T14:11:43.476820",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>date</th>\n",
       "      <th>wcumret</th>\n",
       "      <th>wcumewretd</th>\n",
       "      <th>months</th>\n",
       "      <th>exret</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>2012-01-31</td>\n",
       "      <td>0.176296</td>\n",
       "      <td>0.085342</td>\n",
       "      <td>1</td>\n",
       "      <td>0.090954</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>2012-02-29</td>\n",
       "      <td>0.336930</td>\n",
       "      <td>0.122687</td>\n",
       "      <td>2</td>\n",
       "      <td>0.214243</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>2012-03-30</td>\n",
       "      <td>0.487541</td>\n",
       "      <td>0.140797</td>\n",
       "      <td>3</td>\n",
       "      <td>0.346744</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>2012-04-30</td>\n",
       "      <td>0.515147</td>\n",
       "      <td>0.131862</td>\n",
       "      <td>4</td>\n",
       "      <td>0.383284</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>2012-05-31</td>\n",
       "      <td>0.366925</td>\n",
       "      <td>0.067558</td>\n",
       "      <td>5</td>\n",
       "      <td>0.299367</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>31</th>\n",
       "      <td>2020-08-31</td>\n",
       "      <td>0.613454</td>\n",
       "      <td>0.039283</td>\n",
       "      <td>32</td>\n",
       "      <td>0.574171</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>32</th>\n",
       "      <td>2020-09-30</td>\n",
       "      <td>0.619028</td>\n",
       "      <td>0.022407</td>\n",
       "      <td>33</td>\n",
       "      <td>0.596621</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>33</th>\n",
       "      <td>2020-10-30</td>\n",
       "      <td>0.557577</td>\n",
       "      <td>0.022758</td>\n",
       "      <td>34</td>\n",
       "      <td>0.534819</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>34</th>\n",
       "      <td>2020-11-30</td>\n",
       "      <td>0.406671</td>\n",
       "      <td>0.127467</td>\n",
       "      <td>35</td>\n",
       "      <td>0.279204</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>35</th>\n",
       "      <td>2020-12-31</td>\n",
       "      <td>0.419161</td>\n",
       "      <td>0.178833</td>\n",
       "      <td>36</td>\n",
       "      <td>0.240328</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>107 rows × 5 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "         date   wcumret  wcumewretd  months     exret\n",
       "0  2012-01-31  0.176296    0.085342       1  0.090954\n",
       "1  2012-02-29  0.336930    0.122687       2  0.214243\n",
       "2  2012-03-30  0.487541    0.140797       3  0.346744\n",
       "3  2012-04-30  0.515147    0.131862       4  0.383284\n",
       "4  2012-05-31  0.366925    0.067558       5  0.299367\n",
       "..        ...       ...         ...     ...       ...\n",
       "31 2020-08-31  0.613454    0.039283      32  0.574171\n",
       "32 2020-09-30  0.619028    0.022407      33  0.596621\n",
       "33 2020-10-30  0.557577    0.022758      34  0.534819\n",
       "34 2020-11-30  0.406671    0.127467      35  0.279204\n",
       "35 2020-12-31  0.419161    0.178833      36  0.240328\n",
       "\n",
       "[107 rows x 5 columns]"
      ]
     },
     "execution_count": 60,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "bottom_portfolio_ret\n",
    "#  type(bottom_portfolio_ret)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "papermill": {
     "duration": 0.066012,
     "end_time": "2021-01-21T14:11:43.694581",
     "exception": false,
     "start_time": "2021-01-21T14:11:43.628569",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "** Now which data structures do both bottom_portfolio_ret and top_portfolio_ret belong to?"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "papermill": {
     "duration": 0.110764,
     "end_time": "2021-01-21T14:11:43.871558",
     "exception": false,
     "start_time": "2021-01-21T14:11:43.760794",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "Now, we have a nice monolithic dataframe."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "We can write the above into a function"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 61,
   "metadata": {},
   "outputs": [],
   "source": [
    "def get_portfolio_performance(dates, df, form_period=36, n_stocks=35,\n",
    "                                   benchmark='ewretd', weighting = \"ew\", hold_period = 36, partition = \"permno\"):\n",
    "    \"\"\"\n",
    "    Function computes the average returns of all portfolios formed from the form period, returns both the bottom and top portfolios\n",
    "    \n",
    "    Parameters:\n",
    "        dates (list): List of dates for formation period\n",
    "        df (pandas.DataFrame): original dataframe source \n",
    "        form_period (int): the number of months used to lookback and form the portfolio\n",
    "        n_stocks (int): the number of stocks to form the portfolio \n",
    "        benchmark (str): the benchmark used, either value weighted or equal weighted. See column name in df\n",
    "        weighting (str): either value or equal weighted. \n",
    "        hold_period (int): number of months to hold the portfolio \n",
    "        partition (str): type of partition to be used\n",
    "    Returns:\n",
    "        tuple: contains 2 dataframes, the bottom portfolio and top portfolio\n",
    "    \"\"\"\n",
    "    portfolios = {}\n",
    "    bottom_portfolio_ret = []\n",
    "    top_portfolio_ret = []\n",
    "    \n",
    "    for date in dates:\n",
    "        portfolios[date] = compute_performance_portfolios(date, df, form_period, n_stocks, benchmark, partition)\n",
    "    \n",
    "    for date in dates:\n",
    "        bottom_portfolio_ret.append(compute_holding_returns(date, portfolios[date][0], df, benchmark, weighting, hold_period, partition))\n",
    "        top_portfolio_ret.append(compute_holding_returns(date, portfolios[date][1], df, benchmark, weighting, hold_period, partition))\n",
    "    \n",
    "    bottom_portfolio_ret = pd.concat(bottom_portfolio_ret)\n",
    "    top_portfolio_ret = pd.concat(top_portfolio_ret)\n",
    "    \n",
    "    return bottom_portfolio_ret, top_portfolio_ret\n",
    "\n",
    "def plot_portfolio_performance(bottom_portfolio_ret, top_portfolio_ret, form_period, periodicity):\n",
    "    grads = []\n",
    "    i = periodicity\n",
    "    while(i < form_period):\n",
    "        grads.append(i)\n",
    "        i += periodicity\n",
    "        \n",
    "    ax = bottom_portfolio_ret.groupby('months')['exret'].mean().plot(label='Past losers')\n",
    "    top_portfolio_ret.groupby('months')['exret'].mean().plot(ax=ax, label='Past winners')\n",
    "    ax.legend()\n",
    "    ax.axhline(y=0,  color='black', alpha=0.5, linestyle=':')\n",
    "    for grad in grads:\n",
    "        ax.axvline(x=grad, color='black', alpha=0.5, linestyle='-')\n",
    "        #ax.axvline(x=24, color='black', alpha=0.5, linestyle='-')\n",
    "    return ax"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "papermill": {
     "duration": 0.065709,
     "end_time": "2021-01-21T14:11:44.004068",
     "exception": false,
     "start_time": "2021-01-21T14:11:43.938359",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "<a id=\"subsection-three-three\"></a>\n",
    "## 3.3 Question 3: Do current losers beat current winners in the future?\n"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "papermill": {
     "duration": 0.064884,
     "end_time": "2021-01-21T14:11:44.134301",
     "exception": false,
     "start_time": "2021-01-21T14:11:44.069417",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "<a id=\"subsection-three-one-one\"></a>\n",
    "### 3.1.1 Full sample 2009 - 2020"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 70,
   "metadata": {
    "papermill": {
     "duration": 0.090437,
     "end_time": "2021-01-21T14:11:45.293272",
     "exception": false,
     "start_time": "2021-01-21T14:11:45.202835",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Mean Excess Return for Top Performing Funds 0.5916848930689392\n",
      "P-values 0.13276748543257696\n",
      "we are accepting null hypothesis\n"
     ]
    }
   ],
   "source": [
    "tset, pval = stats.ttest_1samp(top_portfolio_ret[top_portfolio_ret['months']==36].set_index('date')[:'2020']['exret'],0)\n",
    "\n",
    "print('Mean Excess Return for Top Performing Funds ' + str(top_portfolio_ret[top_portfolio_ret['months']==36].set_index('date')[:'2020']['exret'].mean()))\n",
    "print('P-values ' + str(pval))\n",
    "if pval < 0.05:    # alpha value is 0.05 or 5%\n",
    "    print(\" we are rejecting null hypothesis\")\n",
    "else:\n",
    "    print(\"we are accepting null hypothesis\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 71,
   "metadata": {
    "papermill": {
     "duration": 0.088444,
     "end_time": "2021-01-21T14:11:45.452350",
     "exception": false,
     "start_time": "2021-01-21T14:11:45.363906",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Mean Excess Return for Bottom Performing Funds -0.08967338991408844\n",
      "P-values 0.8310861442984903\n",
      "we are accepting null hypothesis\n"
     ]
    }
   ],
   "source": [
    "tset, pval = stats.ttest_1samp(bottom_portfolio_ret[bottom_portfolio_ret['months']==36].set_index('date')[:'2020']['exret'],0)\n",
    "\n",
    "print('Mean Excess Return for Bottom Performing Funds ' + str(bottom_portfolio_ret[bottom_portfolio_ret['months']==36].set_index('date')[:'2020']['exret'].mean()))\n",
    "print('P-values ' + str(pval))\n",
    "if pval < 0.05:    # alpha value is 0.05 or 5%\n",
    "    print(\" we are rejecting null hypothesis\")\n",
    "else:\n",
    "    print(\"we are accepting null hypothesis\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 72,
   "metadata": {
    "papermill": {
     "duration": 0.101216,
     "end_time": "2021-01-21T14:11:45.623089",
     "exception": false,
     "start_time": "2021-01-21T14:11:45.521873",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Mean Excess Return for Top Performing Funds 0.5916848930689392\n",
      "Mean Excess Return for Bottom Performing Funds -0.08967338991408844\n",
      "Mean Difference Bottom Minus Top in Excess Return -0.6813582829830277\n",
      "P-values 0.19331135067907332\n",
      "we are accepting null hypothesis\n"
     ]
    }
   ],
   "source": [
    "tset, pval = stats.ttest_ind(top_portfolio_ret[top_portfolio_ret['months']==36].set_index('date')[:'2020']['exret'],\n",
    "                             bottom_portfolio_ret[bottom_portfolio_ret['months']==36].set_index('date')[:'2020']['exret'])\n",
    "\n",
    "print('Mean Excess Return for Top Performing Funds ' + str(top_portfolio_ret[top_portfolio_ret['months']==36].set_index('date')[:'2020']['exret'].mean()))\n",
    "print('Mean Excess Return for Bottom Performing Funds ' + str(bottom_portfolio_ret[bottom_portfolio_ret['months']==36].set_index('date')[:'2020']['exret'].mean()))\n",
    "print('Mean Difference Bottom Minus Top in Excess Return ' + \n",
    "      str(bottom_portfolio_ret[bottom_portfolio_ret['months']==36].set_index('date')[:'2020']['exret'].mean() -                                                        \n",
    "          top_portfolio_ret[top_portfolio_ret['months']==36].set_index('date')[:'2020']['exret'].mean()))\n",
    "print('P-values ' + str(pval))\n",
    "if pval < 0.05:    # alpha value is 0.05 or 5%\n",
    "    print(\" we are rejecting null hypothesis\")\n",
    "else:\n",
    "    print(\"we are accepting null hypothesis\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "We can again place the above into functions. "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 68,
   "metadata": {},
   "outputs": [],
   "source": [
    "def get_mean_excess_returns(portfolio, end_month, end_year = '1980'):\n",
    "    \"\"\"\n",
    "    Function prints the mean excess returns of the portfolio, and checks if it deviates\n",
    "    significantly from 0. \n",
    "    \n",
    "    Paramters:\n",
    "        portfolio (pandas.DataFrame): 1 of the either portfolios formed from get_portfolio_performance()\n",
    "        end_month (int): the ending month (e.g 36 for the end of the portfolio)\n",
    "        end_year (int): year at which to end the observation\n",
    "    Returns:\n",
    "        null \n",
    "    \"\"\"\n",
    "    tset, pval = stats.ttest_1samp(portfolio[portfolio['months'] == end_month].set_index('date')[:end_year]['exret'], 0)\n",
    "    print(\"Mean Excess Return: \" + str(portfolio[portfolio['months'] == end_month].set_index('date')[:end_year]['exret'].mean()))\n",
    "    res = \"Do Not Reject Null Hypothesis\" if (pval < .05) else \"Reject Null Hypothesis\"\n",
    "    print(\"P-Value: \" + str(pval) + \", \" + res)\n",
    "\n",
    "def get_diff_excess_returns(portfolio1, portfolio2, end_month, end_year = '1980'):\n",
    "    \"\"\"\n",
    "    Function prints the difference in excess returns of 2 portfolios, and checks if it deviates\n",
    "    significantly from 0. \n",
    "    \n",
    "    Paramters:\n",
    "        portfolio1 (pandas.DataFrame): 1 of the either portfolios formed from get_portfolio_performance()\n",
    "        portfolio2 (pandas.DataFrame): 1 of the either portfolios formed from get_portfolio_performance()\n",
    "        end_month (int): the ending month (e.g 36 for the end of the portfolio)\n",
    "        end_year (int): year at which to end the observation\n",
    "    Returns:\n",
    "        null \n",
    "    \"\"\"\n",
    "    mean_ret_1 = portfolio1[portfolio1['months'] == end_month].set_index('date')[:end_year]['exret'].mean()\n",
    "    mean_ret_2 = portfolio2[portfolio2['months'] == end_month].set_index('date')[:end_year]['exret'].mean()\n",
    "    tset, pval = stats.ttest_ind(portfolio1[portfolio1['months'] == end_month].set_index('date')[:end_year]['exret'],\n",
    "                             portfolio2[portfolio2['months'] == end_month].set_index('date')[:end_year]['exret'])\n",
    "    print(\"Mean Excess Return, Top Performers: \" + str(mean_ret_2))\n",
    "    print(\"Mean Excess Return, Bottom Performers: \" + str(mean_ret_1))\n",
    "    print(\"Mean Difference (Bottom - Top) in Excess Returns: \" + str(mean_ret_1 - mean_ret_2))\n",
    "    res = \"Do Not Reject Null Hypothesis\" if (pval > .05) else \"Reject Null Hypothesis\"\n",
    "    print(\"P-Value: \" + str(pval) + \", \" + res)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "jp-MarkdownHeadingCollapsed": true,
    "papermill": {
     "duration": 0.070351,
     "end_time": "2021-01-21T14:11:45.763389",
     "exception": false,
     "start_time": "2021-01-21T14:11:45.693038",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "<a id=\"section-four\"></a>\n",
    "# 4. CONCLUSION \n",
    "\n",
    "Our empirical results (From 1933-2000) show that loser portfolios dramatically outperform winner portfolios, consistent with DeBondt and Thaler (1985). Over long holding period horizons, stocks appear to register significant price reversals. For example, the loser portfolio, made up of the worst-performing stocks in the formation period, consistently outperforms the winner portfolio during the evaluation period. One plausible explanation for the substantial amount of price reversal is based on behavioural finance, in that investors tend to overweight recent performance and underweight longer-term or baseline information in their decisions.\n",
    "\n",
    "For example, if a stock has recently suffered an earnings shortfall because of some temporary non-structural shift in economic opportunities, the price decline may be exaggerated due to the recentness of the news. Once depressed, the price may be slow to recover until investors realize their “overreaction” to the temporary bad news associated with the earnings deficiency, which then creates buying pressure to “reverse” the price decline.\n",
    "\n",
    "Adjusting beliefs to realistic longer-term opportunities, instead of shorter-term prospects and bases of information, causes the reversal. In the original paper, DeBondt and Thaler (1985) find a significant persistence to this reversal phenomenon and indicate that markets tend to suffer from investor overreaction."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "<a id=\"section-five\"></a>\n",
    "# 5. Problem Set 1: Question 2 \n",
    "\n",
    "## Evaluate whether the buy-losers-sell-winners strategy still works in the recent 12 years (i.e., January 2009 to December 2020). Compare and contrast what you find with DeBondt and Thaler (1985)."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 69,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Mean Excess Return, Top Performers: 0.5916848930689392\n",
      "Mean Excess Return, Bottom Performers: -0.08967338991408844\n",
      "Mean Difference (Bottom - Top) in Excess Returns: -0.6813582829830277\n",
      "P-Value: 0.19331135067907332, Do Not Reject Null Hypothesis\n"
     ]
    }
   ],
   "source": [
    "get_diff_excess_returns(bottom_portfolio_ret, top_portfolio_ret, 36, '2020')"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 62,
   "metadata": {
    "papermill": {
     "duration": 0.24368,
     "end_time": "2021-01-21T14:11:44.443473",
     "exception": false,
     "start_time": "2021-01-21T14:11:44.199793",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/plain": [
       "<matplotlib.lines.Line2D at 0x144b7e24eb0>"
      ]
     },
     "execution_count": 62,
     "metadata": {},
     "output_type": "execute_result"
    },
    {
     "data": {
      "image/png": "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\n",
      "text/plain": [
       "<Figure size 432x288 with 1 Axes>"
      ]
     },
     "metadata": {
      "needs_background": "light"
     },
     "output_type": "display_data"
    }
   ],
   "source": [
    "ax = bottom_portfolio_ret.groupby('months')['exret'].mean().plot(label='Past losers')\n",
    "top_portfolio_ret.groupby('months')['exret'].mean().plot(ax=ax, label='Past winners')\n",
    "ax.legend()\n",
    "ax.axhline(y=0,  color='black', alpha=0.5, linestyle=':')\n",
    "ax.axvline(x=12, color='black', alpha=0.5, linestyle='-')\n",
    "ax.axvline(x=24, color='black', alpha=0.5, linestyle='-')"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Conclusion\n",
    "Based on the recent empirical results (2009-2020), we can conclude that the Debondt and Thaler (1985) findings do not hold true in the recent years. The winner portfolio outperforms the loser portfolio in every observed timeframe."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "papermill": {
     "duration": 0.068957,
     "end_time": "2021-01-21T14:11:45.902312",
     "exception": false,
     "start_time": "2021-01-21T14:11:45.833355",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "<a id=\"section-six\"></a>\n",
    "# 6. REFERENCES"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "papermill": {
     "duration": 0.068974,
     "end_time": "2021-01-21T14:11:46.040981",
     "exception": false,
     "start_time": "2021-01-21T14:11:45.972007",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "De BONDT, W.F.M. and THALER, R. (1985), Does the Stock Market Overreact?. The Journal of Finance, 40: 793-805. doi:10.1111/j.1540-6261.1985.tb05004.x\n",
    "\n",
    "This notebook is adapted from code written by [Charles Martineau](http://www.charlesmartineau.com/), the University of Toronto and [Vincent Grégoire](http://www.vincentgregoire.com), Department of Finance, The University of Melbourne. \n"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3 (ipykernel)",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.9.7"
  },
  "papermill": {
   "duration": 35.980962,
   "end_time": "2021-01-21T14:11:46.216236",
   "environment_variables": {},
   "exception": null,
   "input_path": "__notebook__.ipynb",
   "output_path": "__notebook__.ipynb",
   "parameters": {},
   "start_time": "2021-01-21T14:11:10.235274",
   "version": "2.1.0"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}
